---
title: "Prob switch analyses"
output: html_notebook
---

# Set switches

```{r Set up parameters}
gg_save = T
data = "fitted_human"  # Can be "human", "fitted_human", or "fitted_sim"
library("ggplot2"); theme_set(theme_bw()); library("plyr"); library("reshape2"); library("R.matlab"); library("zoo")

base_dir = "C:/Users/maria/MEGAsync/SLCNdata/PSResults"
plot_dir = file.path(base_dir, "plots")
  
if (data == "fitted_human") {
  base_dir = file.path(base_dir, "fit_pars")
} else if (data == "fitted_sim") {
  base_dir = "C:/Users/maria/MEGAsync/SLCN/PSGenRec"
  genrec_dir = base_dir
}

ages = read.csv("C:/Users/maria/MEGAsync/SLCNdata/SLCNinfo.csv")
ages$age_group = "Adults"
ages$age_group[ages$PreciseYrs < 18] = "Teens"
ages$age_group[ages$PreciseYrs < 13] = "Children"
ages$age_group = factor(ages$age_group, levels = c("Children", "Teens", "Adults"))
ages$PDS[ages$age_group == "Adults"] = 6
ages
  
unlink(plot_dir, recursive=TRUE)  # Delete old plots
dir.create(plot_dir)
```

# Read in and clean data

```{r Read in data}
all_params = data.frame()
all_files = data.frame()

if (data %in% c("human", "fitted_human")) {
  data_dir = base_dir
}
filenames = list.files(data_dir, pattern = ifelse(data == "human", "*.mat", "*PS_[0-9]*.csv"))
filename = filenames[1] # debugging

for(filename in filenames) {
  if (data == "human") {
    mat_file = readMat(file.path(data_dir, filename))$exp[,,1]$PROBSWITCHdata[,,1]
    subj_file = data.frame(RT = t(mat_file$RT))
    subj_file$selected_box = (t(mat_file$key) - 10) / 2
    subj_file$reward = t(mat_file$reward)
    subj_file$correct_box = 1 - t(mat_file$better.box.left)  # left: 0; right: 1
    sID = as.numeric(strsplit(strsplit(filename, split = "PROBSWITCH_")[[1]][2], ".mat")[[1]])
    subj_file$sID = sID
    subj_file = subset(subj_file, !is.nan(reward) & selected_box %in% c(0, 1))
    subj_file = subj_file[47:nrow(subj_file),]  # needs to be changed for future participants - 51
  } else {
    subj_file = read.csv(file.path(data_dir, filename))
    subj_file$X = NULL
    subj_file$p_switch_rec = NULL
  }
  subj_file$TrialID = 1:nrow(subj_file)
  subj_file$rewardversion = subj_file$sID %% 4
  subj_file$ACC = with(subj_file, selected_box == correct_box)
  
  # Get trials since last switch (forward pass -> numbers > 0)
  subj_file$switch_trial = NA
  box_prev_trial = subj_file$correct_box[1]
  block = 1
  trialsinceswitch = 0
  for (t in subj_file$TrialID) {
    # Find switch trials
    subj_file$switch_trial[t] = box_prev_trial != subj_file$correct_box[t]
    box_prev_trial = subj_file$correct_box[t]
    # Get blocks
    block = block + subj_file$switch_trial[t]
    subj_file$block[t] = block
    trialsinceswitch = ifelse(subj_file$switch_trial[t] == 1, 0, trialsinceswitch + 1)
    subj_file$trialsinceswitch[t] = trialsinceswitch
  }
  # Get trials since last switch (backward pass -> numbers < 0)
  block = 1
  trialsinceswitch = 0
  for (t in rev(subj_file$TrialID)) {
    trialsinceswitch = ifelse(subj_file$switch_trial[t] == 1, 0, trialsinceswitch - 1)
    if (trialsinceswitch > -4) {
      subj_file$trialsinceswitch[t] = trialsinceswitch
    }
  }
  
  outcome_1_back = c(NA, subj_file$reward[1:(nrow(subj_file) - 1)])
  subj_file$outcome_1_back = outcome_1_back
  outcome_2_back = c(NA, NA, subj_file$reward[1:(nrow(subj_file) - 2)])
  subj_file$outcome_2_back = outcome_2_back
  
  subj_file$choice_left = subj_file$selected_box == 0  # left: 0; right: 1
  subj_file$choice_1_back = c(NA, subj_file$choice_left[1:(nrow(subj_file) - 1)])
  subj_file$choice_2_back = c(NA, NA, subj_file$choice_left[1:(nrow(subj_file) - 2)])
  
  if (data == "human") {
    write.csv(subj_file, paste(data_dir, "/PS_", sID, ".csv", sep = ""), row.names = F)
  }
  
  all_files = as.data.frame(rbind(all_files, subj_file))
}

all_files$outcome_12_back = paste(all_files$outcome_1_back, all_files$outcome_2_back)
all_files$outcome_12_back = factor(all_files$outcome_12_back, levels = c("1 1", "1 0", "0 1", "0 0"))
all_files$same_choice_01_back = all_files$choice_left == all_files$choice_1_back  # same choice in this trial as in the last?
all_files$same_choice_12_back = all_files$choice_1_back == all_files$choice_2_back  # same choice in this trial as in the last?
all_files$choice_12_back = ifelse(all_files$choice_1_back, "left", "right")
all_files$choice_12_back[!all_files$same_choice_12_back | is.na(all_files$same_choice_12_back)] = NA
all_files$reward_port = factor(all_files$correct_box, levels = c(0, 1), labels = c("Left", "Right"))
all_files = subset(all_files, sID > 16)
if (data == "fitted_humans") {
  all_files$learning_style = factor(all_files$learning_style)
  all_files$method = factor(all_files$method)
}
all_files = merge(all_files, ages, by.x = "sID", by.y = "ID", all.x = T)
summary(all_files)
```
  
```{r Get Parameter data}
if (data != "human") {
  all_params = ddply(all_files,
                        .(sID, age_group, learning_style, fit_pars), summarize,
                        alpha = mean(alpha_rec),
                        beta = mean(beta_rec),
                        epsilon = mean(epsilon_rec),
                        LL_rec = mean(LL_rec),
                        BIC = mean(BIC_rec),
                        AIC = mean(AIC_rec))
  ddply(all_params, .(age_group, learning_style), summarize,
      BIC = mean(BIC))
}
```

# Analyze model parameters, gen_rec, etc.

```{r plot example values and example probs}
if (!data == "human") {
  
  # Plot values for one example session
  ex_dat = subset(all_files, sID < 100)
  gg_example_values = ggplot(ex_dat) +
    geom_line(aes(TrialID, values_l_rec), color="red") +
    geom_line(aes(TrialID, values_r_rec), color="blue") +
    # geom_vline(xintercept = which(ex_dat$switch_trial)) +
    # geom_point(aes(TrialID, reward - 0.5)) +
    geom_point(aes(TrialID, 0.5, color = choice_left, size = factor(reward))) +
    geom_point(aes(TrialID, as.numeric(as.character(factor(switch_trial, labels = c(-5, 0.5))))), shape = 8, size = 3, color = "darkgreen") +
    scale_size_manual(values = c(0.5, 1)) +
    scale_color_manual(values = c("blue", "red")) +
    coord_cartesian(x = c(1, 80), y = c(0, 1)) +
    labs(x = "Trial", y = "Values (left: red; right: blue)") +
    theme(legend.position = 'none') +
    facet_wrap(~ sID, ncol = 2)
  
  # Plot action probs for one example session
  gg_example_probs = gg_example_values +
    geom_line(aes(TrialID, p_action_l_rec), color="red") +
    geom_line(aes(TrialID, p_action_r_rec), color="blue")
  
  if (gg_save) {
    ggsave(file.path(plot_dir, "gg_example_values.png"), gg_example_values, width = 12, height = 8)
    ggsave(file.path(plot_dir, "gg_example_probs.png"), gg_example_probs, width = 12, height = 8)
  }
  
  gg_switch_values = ggplot(all_files, aes(trialsinceswitch, values_l_rec, color = reward_port, group = reward_port)) +
    stat_summary(fun.data = "mean_se", geom = "smooth") +
    coord_cartesian(x = c(-3, 5))
  
  gg_trial_values = ggplot(all_files) +
    stat_summary(aes(TrialID, values_l_rec), color = "red", fun.data = "mean_se", geom = "smooth") +
    stat_summary(aes(TrialID, values_r_rec), color = "blue", fun.data = "mean_se", geom = "smooth") +
    facet_grid(~ rewardversion)
  
  if (gg_save) {
    ggsave(file.path(plot_dir, "/gg_trial_values.png"), gg_trial_values)
    ggsave(file.path(plot_dir, "/gg_switch_values.png"), gg_switch_values)
  }
}
```
```{r Genrec Plots}
if (data == "fitted_sim") {
  # Plot generated against recovered parameter values
  genrec = read.csv(file.path(genrec_dir, 'genrec.csv'))
  genrec$X = NULL
  gen_plot = subset(genrec, learning_style != "estimate-switch")
  gg_genrec_a = ggplot(gen_plot, aes(alpha_gen, alpha_rec, color=fit_par, shape=fit_par)) +
    geom_abline(slope=1, linetype="dotted") +
    geom_point() +
    scale_shape_manual(values=1:length(unique(gen_plot$fit_par))) +
    facet_grid(learning_style ~ method)
  gg_genrec_b = gg_genrec_a + aes(beta_gen, beta_rec)
  gg_genrec_e = gg_genrec_a + aes(epsilon_gen, epsilon_rec)
  gg_genrec_p = gg_genrec_a + aes(perseverance_gen, perseverance_rec)
  gg_genrec_d = gg_genrec_a + aes(decay_gen, decay_rec)
  gg_genrec_wr = gg_genrec_a + aes(w_reward_gen, w_reward_rec)
  gg_genrec_we = gg_genrec_a + aes(w_explore_gen, w_explore_rec)
  gg_genrec_wn = gg_genrec_a + aes(w_noreward_gen, w_noreward_gen)
  
  if (gg_save) {
    ggsave(file.path(plot_dir, "/gg_genrec_a.png"), gg_genrec_a, width = 11, height = 8)
    ggsave(file.path(plot_dir, "/gg_genrec_b.png"), gg_genrec_b, width = 11, height = 8)
    ggsave(file.path(plot_dir, "/gg_genrec_e.png"), gg_genrec_e, width = 11, height = 8)
    ggsave(file.path(plot_dir, "/gg_genrec_p.png"), gg_genrec_p, width = 11, height = 8)
    ggsave(file.path(plot_dir, "/gg_genrec_d.png"), gg_genrec_d, width = 11, height = 8)
    ggsave(file.path(plot_dir, "/gg_genrec_wr.png"), gg_genrec_wr, width = 11, height = 8)
    ggsave(file.path(plot_dir, "/gg_genrec_we.png"), gg_genrec_we, width = 11, height = 8)
    ggsave(file.path(plot_dir, "/gg_genrec_wn.png"), gg_genrec_wn, width = 11, height = 8)
  }
}
```
```{Plot parameters}
if (data == "fitted_humans") {
  
  all_params = reshape(subset(all_params, select = c("sID", "age_group", "BIC", "learning_style")),
          timevar = "learning_style", idvar = c("sID", "age_group"), direction = "wide")
  
  ggplot(all_params, aes(sID, BIC.flat - BIC.Bayes, color = sID)) +
    geom_point(position = "jitter") +
    geom_hline(yintercept = 0, linetype = "dotted")
  
  all_paramsl = melt(all_params, measure.vars = c("BIC", "AIC"), variable.name = "measure")

  gg_fit = ggplot(subset(all_paramsl, measure == "BIC"), aes(learning_style, value, color = learning_style)) +
    stat_summary(fun.data = "mean_se", geom = "pointrange") +
    # geom_point(position = "jitter", alpha = 0.5) +
    facet_grid(age_group ~ .) +
    labs(x = "", y = "BIC")
    theme(legend.position = "none")
  
  fitted_paramsl = melt(all_params, measure.vars = c("alpha", "beta", "epsilon", "perseverance", "decay"), variable.name = "parameter")
  fitted_paramsl[fitted_paramsl$parameter == 'beta', 'value'] = fitted_paramsl[fitted_paramsl$parameter == 'beta', 'value'] / 10
  gg_params = ggplot(fitted_paramsl, aes(parameter, value, color = age_group, fill = age_group)) +
    stat_summary(fun.data = "mean_se", geom = "pointrange", position = position_dodge(width = 0.8)) +
    # geom_point(position = "jitter", alpha = 0.3) +
    labs(x = "", y = "Parameter value", color = "Age group", fill = "Age group") +
    facet_grid(learning_style ~ .)
  
  if (gg_save) {
    ggsave(file.path(plot_dir, "gg_fit2.png"), gg_fit)
    ggsave(file.path(plot_dir, "gg_params.png"), gg_params)
  }
}
```

# Analyze behavior

```{r Get behavioral summary and win-stay loose-shift}
# Behavior
all_files_sum = ddply(subset(all_files, !is.na(choice_12_back)),
                      .(sID, age_group, outcome_12_back, choice_12_back), summarize,
                      choice = mean(choice_left, na.rm = T))
all_files_sum2 = ddply(subset(all_files, !is.na(trialsinceswitch)),
                       .(sID, age_group, trialsinceswitch), summarize,
                       choice = mean(choice_left, na.rm = T),
                       RT = median(RT, na.rm = T))
# Win-stay loose-shift
stay = with(all_files, c(choice_left == choice_1_back))
all_files$stay = c(stay[2:length(stay)], NA)
wsls = ddply(all_files, .(sID, reward, age_group), summarize,
             stay = mean(stay, na.rm = T))
wsls$reward = factor(wsls$reward)
```
```{r Basic behavioral analyses}
# Response times
gg_RT = ggplot(all_files, aes(TrialID, RT, fill = age_group)) +
  # geom_point() +
  stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1), geom = "bar", position = position_dodge(width = 0.9)) +
  facet_grid(~ age_group)

gg_RTt = ggplot(all_files_sum2, aes(trialsinceswitch, RT, fill = age_group)) +
  stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1), geom = "bar", position = position_dodge(width = 0.9)) +
  stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1), geom = "pointrange", position = position_dodge(width = 0.9)) +
  # geom_point(alpha = .3, position = "jitter") +
  coord_cartesian(x = c(-3, 5)) +
  facet_grid(~ age_group)

# ACC over trials
gg_ACC = ggplot(all_files, aes(TrialID, 100 * as.numeric(ACC), fill = age_group)) +
  stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1), geom = "bar") +
  labs(y = "% correct", fill = "Age group") +
  facet_grid(~ age_group)
if (data == "fitted_sim") {
  gg_ACC = gg_ACC + facet_grid(learning_style ~ method)
}

# ACC over blocks
gg_ACC_blocks = ggplot(subset(all_files, !is.na(choice_left)),
                       aes(trialsinceswitch, 100 * choice_left, color = reward_port, group = reward_port, shape = age_group)) +
  stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1), geom = "pointrange") +
  stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1), geom = "line") +
  geom_vline(xintercept = 0, linetype = "dotted") +
  coord_cartesian(x = c(-3, 7)) +
  labs(x = "Trials since switch", y = "% choice left", color = "Reward port", shape = "Age group") +
  facet_grid(~ age_group)
if (data == "fitted_sim") {
  gg_ACC_blocks = gg_ACC_blocks + facet_grid(learning_style ~ method)
}

# Response times
gg_RT_blocks = gg_ACC_blocks + aes(y = RT) + coord_cartesian(x = c(-3, 7), y = c(250, 650))

# Rewards over trials
gg_rewards = ggplot(all_files, aes(TrialID, 100 * reward, fill = age_group)) +
  stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1), geom = "bar") +
  labs(y = "% reward received", color = "Age group") +
  facet_grid(~ age_group)
if (data != "human") {
  gg_rewards = gg_rewards + facet_grid(learning_style ~ method)
}

gg_rewards2 = ggplot(subset(all_files_sum, !is.na(choice_12_back)),
                     aes(outcome_12_back, 100 * choice, fill = choice_12_back, group = choice_12_back, shape = age_group)) +
  stat_summary(fun.data = mean_cl_normal, geom = "bar", fun.args = list(mult = 1), position = "dodge") +
  stat_summary(fun.data = mean_cl_normal, geom = "pointrange", fun.args = list(mult = 1), position = position_dodge(0.9)) +
  coord_cartesian(y = c(0, 100)) +
  labs(x = "Reward history (1 trial back, 2 trials back)", y = "% left choice", fill = "Previous two choices", shape = "Age group") +
  facet_grid(~ age_group)
if (data == "fitted_sim") {
  gg_rewards2 = gg_rewards2 + facet_grid(learning_style ~ method)
}

if (gg_save) {
  if (data %in% c("human", "fitted_human")) {
    ggsave(file.path(plot_dir, "/gg_RT.png"), gg_RT)
    ggsave(file.path(plot_dir, "/gg_RTt.png"), gg_RTt)
    ggsave(file.path(plot_dir, "/gg_ACC.png"), gg_ACC)
    ggsave(file.path(plot_dir, "/gg_RT_blocks.png"), gg_RT_blocks, width = 8, height = 3)
  }
  ggsave(file.path(plot_dir, "/gg_ACC_blocks.png"), gg_ACC_blocks, width = 8, height = 3)
  ggsave(file.path(plot_dir, "/gg_rewards.png"), gg_rewards)
  ggsave(file.path(plot_dir, "/gg_rewards2.png"), gg_rewards2, width = 8, height = 3)
}
```
```{r WSLS}
gg_wsls = ggplot(wsls, aes(reward == 1, stay, color = reward == 1, shape = age_group)) +
  stat_summary(fun.data = "mean_se", geom = "pointrange") +
  geom_point(alpha = 0.5, position = "jitter") +
  labs(x = "Reward", y = "% stay trials", color = "Reward", shape = "Age group") +
  facet_grid(~ age_group)
if (data == "fitted_sim") {
  gg_wsls = gg_wsls + facet_grid(learning_style ~ method)
}

if (gg_save) {
  ggsave(file.path(plot_dir, "/gg_wsls.png"), gg_wsls)
}
```

# Run regression models

```{r Prepare data for regression}
# Prepare data
all_files_regr = subset(all_files, select = c("sID", "TrialID", "block", "reward", "selected_box"))
## Times rewarded and times selected
all_files_regr$selected = as.numeric(as.character(factor(all_files_regr$selected_box, levels = c(0, 1), labels = c(-1, 1))))  # 0 / -1: left; +1: right
## Choice regressors
all_files_regr$right_rew = all_files_regr$selected_box
all_files_regr$right_rew[all_files_regr$reward == 0] = -all_files_regr$right_rew[all_files_regr$reward == 0]
all_files_regr$left_rew = 1 - all_files_regr$selected_box
all_files_regr$left_rew[all_files_regr$reward == 0] = -all_files_regr$left_rew[all_files_regr$reward == 0]
## Reward regressors
all_files_regr$reward = all_files_regr$reward
all_files_regr$reward[all_files_regr$selected_box == 0] = -all_files_regr$reward[all_files_regr$selected_box == 0]
all_files_regr$noReward = 1 - all_files_regr$reward
all_files_regr$noReward[all_files_regr$selected_box == 0] = -all_files_regr$noReward[all_files_regr$selected_box == 0]
all_files_regr$selected_box = factor(all_files_regr$selected_box)
all_files_regr
```

```{r Run regression action ~ action_nback * reward_nback and save in nback_regr_dat}
# Run regression models for each subject, for each n in n-back
sel_rew_predictors = c("selected", "reward")
choice_predictors = c("left_rew", "right_rew")
reward_predictors = c("reward", "noReward")

nback_regr_dat = data.frame()
for (subj in unique(all_files_regr$sID)) {
  for (n in 1:12) {
    subj_dat = subset(all_files_regr, sID == subj, !is.na(selected_box))
    
    ## Add nback columns
    for (cond in c(choice_predictors, reward_predictors, sel_rew_predictors)) {
      col_name = paste0("back", n, cond)
      subj_dat[,col_name] = c(rep(NA, n), subj_dat[1:(nrow(subj_dat)-n), cond])
    }
    
    ## Selected/rewarded model (predictors: selected [left: -1, right: +1], reward [left: -1, right: +1, none: 0])
    sel_rew_formula = paste("selected_box ~", paste(paste0("back", n, sel_rew_predictors), collapse = " + "), "+ (1 | block)")
    sel_rew_mod = glm(as.formula(sel_rew_formula),
              family = "binomial",
              data = subj_dat)
    sel_rew_coefs = as.data.frame(summary(sel_rew_mod)$coef)
    sel_rew_coefss = cbind(sID = subj, model = "selectedRewarded", predictor = rownames(sel_rew_coefs), back = n, data.frame(sel_rew_coefs, row.names = NULL))
    
    ## Choice model (predictors: left_rew [reward: +1, no reward: -1, none: 0], right_rew [reward: +1, no reward: -1, none: 0])
    choice_formula = paste("selected_box ~ ", paste(paste0("back", n, choice_predictors), collapse = "+"))
    choice_mod = glm(as.formula(choice_formula),
              family = "binomial",
              data = subj_dat)
    choice_coefs = as.data.frame(summary(choice_mod)$coef)
    choice_coefss = cbind(sID = subj, model = "leftRight", predictor = rownames(choice_coefs), back = n, data.frame(choice_coefs, row.names = NULL))

    ## Reward model (predictors: reward [left: -1, right: +1, none: 0], no reward [left: -1, right: +1, none: 0])
    reward_formula = paste("selected_box ~ ", paste(paste0("back", n, reward_predictors), collapse = "+"))
    reward_mod = glm(as.formula(reward_formula),
              family = "binomial",
              data = subj_dat)
    reward_coefs = as.data.frame(summary(reward_mod)$coef)
    reward_coefss = cbind(sID = subj, model = "rewardNoReward", predictor = rownames(reward_coefs), back = n, data.frame(reward_coefs, row.names = NULL))
    
    nback_regr_dat = rbind(nback_regr_dat, choice_coefss, reward_coefss, sel_rew_coefss)
  }
}
# Beautify
nback_regr_dat = merge(nback_regr_dat, ages, by.x = "sID", by.y = "ID", all.x = T)
nback_regr_dat$predictor = gsub("back.", "", nback_regr_dat$predictor)
nback_regr_dat$predictor = gsub("[0-99]", "", nback_regr_dat$predictor)
nback_regr_dat$sig_Estimate = 1 / (1 + exp(-nback_regr_dat$Estimate / 2))  # transform so that I can see all
# nback_regr_dat
```
```{r Plot relationship between regressors and age}
# Plot
gg_nback_regr_agecont =
  ggplot(subset(nback_regr_dat, predictor != "(Intercept)" & back %in% seq(1, 12, 2)),
         aes(PreciseYrs, Estimate, color = predictor, fill = predictor, alpha = factor(12 - back))) +
  geom_smooth() +
  geom_point() +
  labs(x = "Age (years)", y = "P(right) ~ choice_reward", color = "Choice", fill = "Choice", alpha = "# Trials back: 12-...") +
  facet_grid(model ~ .)
gg_nback_regr_agecont_sig = gg_nback_regr_agecont + aes(y = sig_Estimate)

gg_nback_regr_agecats =
  ggplot(subset(nback_regr_dat, predictor != "(Intercept)"), aes(back, Estimate, color = age_group, group = age_group)) +
  # geom_point(position = "jitter", alpha = 0.15) +
  stat_summary(fun.data = mean_se, geom = "pointrange") +
  stat_summary(fun.data = mean_se, geom = "line") +
  labs(x = "# trials back", y = "beta weight", color = "Side") +
  facet_grid(~ predictor)
gg_nback_regr_agecats_sig = gg_nback_regr_agecats + aes(y = sig_Estimate)

# Save plots
ggsave(file.path(plot_dir, "gg_nback_regr_agecats.png"), gg_nback_regr_agecats, width=8, height=3)
ggsave(file.path(plot_dir, "gg_nback_regr_agecats_sig.png"), gg_nback_regr_agecats_sig, width=8, height=3)
ggsave(file.path(plot_dir, "gg_nback_regr_agecont.png"), gg_nback_regr_agecont, width=7, height=12)
ggsave(file.path(plot_dir, "gg_nback_regr_agecont_sig.png"), gg_nback_regr_agecont_sig, width=7, height=12)
```
```{r Fit exponential model to regression weights}
# Visualize one example
dat = subset(nback_regr_dat, sID == 17 & predictor == "reward")
# exp_mod = nls(Estimate ~ k * exp(-lambda * back), data = dat, start = list(k = .1, lambda = .1))
exp_mod = nls(Estimate ~ k * exp(-back), data = dat, start = list(k = .1))
plot(dat$back, dat$Estimate)
lines(dat$back, predict(exp_mod, list(x = dat$back)))

# Run on all participants
exp_coefs = data.frame()
for (subj in unique(nback_regr_dat$sID)) {
  for (pred in unique(nback_regr_dat$predictor[nback_regr_dat$predictor != "(Intercept)"])) {
    subj_dat = subset(nback_regr_dat, sID == subj & predictor == pred)
    exp_mod =
      try(nls(Estimate ~ k * exp(-back), data = subj_dat, start = list(k = .1)), silent = T)
    if (class(exp_mod) != "try-error") {
      subj_coefs = summary(exp_mod)$coef
      # subj_coefs = cbind(sID = subj, regr_predictor = pred, exp_predictor = rownames(subj_coefs), as.data.frame(subj_coefs, row.names = F))
      subj_coefs = cbind(sID = subj, regr_predictor = pred, exp_predictor = rownames(subj_coefs), as.data.frame(subj_coefs, row.names = '1'))
      exp_coefs = rbind(exp_coefs, subj_coefs)
    }
  }
}
exp_coefs = merge(exp_coefs, ages, by.x = "sID", by.y = "ID", all.x = T)
exp_coefs$sig_Estimate = NA
exp_coefs$sig_Estimate[exp_coefs$exp_predictor == "k"] = 1 / (1 + exp(-exp_coefs$Estimate[exp_coefs$exp_predictor == "k"] / 5))
exp_coefs$sig_Estimate[exp_coefs$exp_predictor == "lambda"] = 1 / (1 + exp(-exp_coefs$Estimate[exp_coefs$exp_predictor == "lambda"] / .5))
```
```{r Plot parameters of the exponential model}
gg_exp_coefs_age = ggplot(exp_coefs, aes(PreciseYrs, Estimate, color = regr_predictor)) +
  geom_point() +
  geom_smooth() +
  labs(y = "Regr beta ~ k * exp(-lambda * back)") +
  facet_wrap(~ exp_predictor, scale = "free")
gg_exp_coefs_age_sig = gg_exp_coefs_age + aes(y = sig_Estimate)

gg_exp_coefs_agecat =
  ggplot(subset(exp_coefs), aes(age_group, Estimate, color = regr_predictor, group = regr_predictor)) +
  geom_point(position = "jitter", alpha = 0.2) +
  stat_summary(fun.data = mean_se) +
  labs(y = "Regr beta ~ k * exp(-lambda * back)") +
  stat_summary(fun.data = mean_se, geom = "line") +
  facet_wrap(~ exp_predictor, scale = "free")
gg_exp_coefs_agecat_sig = gg_exp_coefs_agecat + aes(y = sig_Estimate)

ggsave(file.path(plot_dir, "gg_exp_coefs_age_sig.png"), gg_exp_coefs_age_sig)
ggsave(file.path(plot_dir, "gg_exp_coefs_agecat_sig.png"), gg_exp_coefs_agecat_sig)
ggsave(file.path(plot_dir, "gg_exp_coefs_age.png"), gg_exp_coefs_age)
ggsave(file.path(plot_dir, "gg_exp_coefs_agecat.png"), gg_exp_coefs_agecat)
```
```{r Relationship with age and puberty: Other measures}
# Overall ACC
sum_dat = ddply(all_files, .(sID, PreciseYrs, Gender, Category, PDS), summarize,
                mean_ACC = mean(ACC, na.rm = T),
                median_RT = median(RT, na.rm = T),
                n_blocks = max(block, na.rm = T),
                stay = mean(stay, na.rm = T))

gg_age_ACC =
  ggplot(sum_dat, aes(PreciseYrs, mean_ACC)) +
  geom_point() +
  geom_smooth()
gg_age_RT = gg_age_ACC + aes(y = median_RT)
gg_PDS_ACC = gg_age_ACC + aes(x = PDS)
gg_PDS_RT = gg_PDS_ACC + aes(y = median_RT)
gg_age_n_blocks = gg_age_ACC + aes(y = n_blocks)
gg_PDS_n_blocks = gg_age_n_blocks + aes(x = PDS)
gg_age_overall_stay = gg_age_ACC + aes(y = stay)
gg_PDS_overall_stay = gg_age_overall_stay + aes(x = PDS)

# Trials to reach criterion
all_files$roll_ACC = rollmean(all_files$ACC, 3, fill = NA, align = "right")
all_files$roll_ACC[all_files$trialsinceswitch >= 0 & all_files$trialsinceswitch < 2] = NA
all_files$criterion_2of3 = all_files$roll_ACC >= 0.6
criterion_dat = ddply(subset(all_files, criterion_2of3 == T & trialsinceswitch > 0), .(sID, PreciseYrs, Gender, Category, PDS, block), summarize,
      trials_to_criterion = min(trialsinceswitch))

gg_age_criterion = ggplot(criterion_dat, aes(PreciseYrs, trials_to_criterion)) +
  geom_point() +
  geom_smooth()
gg_PDS_criterion = gg_age_criterion + aes(x = PDS)

# Prominence of WSLS
wsls_wide = reshape(subset(wsls, select = -age_group), direction = "wide", timevar = "reward", idvar = "sID")
wsls_wide$wsls = with(wsls_wide, stay.1 + (1 - stay.0))
wsls_wide = merge(wsls_wide, ages, by.x = "sID", by.y = "ID", all.x = T)
wsls = merge(wsls, ages, by.x = "sID", by.y = "ID", all.x = T)

gg_age_wsls = ggplot(wsls, aes(PreciseYrs, stay, color = reward)) +
  geom_point() +
  geom_smooth()
gg_PDS_wsls = gg_age_wsls + aes(x = PDS)

# Effect of reward history
all_files
rewhist_dat = ddply(all_files, .(sID, outcome_12_back), summarize,
                    stay = mean(same_choice_01_back, na.rm = T))
rewhist_dat = merge(rewhist_dat, ages, by.x = "sID", by.y = "ID", all.x = T)
gg_age_rewhist =
  ggplot(subset(rewhist_dat, !is.na(outcome_12_back)), aes(PreciseYrs, stay, color = outcome_12_back)) +
  geom_point() +
    geom_smooth()
gg_PDS_rewhist = gg_age_rewhist + aes(x = PDS)

# RT variability || age
RT_sd_dat = ddply(all_files, .(sID, PreciseYrs, PDS), summarize,
      RT_sd = sd(RT, na.rm = T))
gg_age_RT_sd = ggplot(RT_sd_dat, aes(PreciseYrs, RT_sd)) +
  geom_point() +
  geom_smooth()
gg_PDS_RT_sd = gg_age_RT_sd + aes(x = PDS)

# RT ~ trialID || age
RT_slope_dat = data.frame()
for (subj in unique(all_files$sID)) {
  subj_dat = subset(all_files, sID == subj)
  RT_mod = lm(RT ~ TrialID, data = subj_dat)
  coefs = as.data.frame(summary(RT_mod)$coefficients)
  coefss = cbind(sID = subj, predictor = rownames(coefs), data.frame(coefs, row.names = NULL))
  RT_slope_dat = rbind(RT_slope_dat, rbind(coefss))
}
RT_slope_dat = merge(RT_slope_dat, ages, by.x = "sID", by.y = "ID", all.x = T)

gg_age_RT_slope = ggplot(subset(RT_slope_dat, predictor == "TrialID"), aes(PreciseYrs, Estimate)) +# & `Pr...t..` < 0.05
  geom_point() +
  geom_smooth()
gg_PDS_RT_slope = gg_age_RT_slope + aes(x = PDS)

# Save plots
ggsave(file.path(plot_dir, "gg_age_criterion.png"), gg_age_criterion)
ggsave(file.path(plot_dir, "gg_PDS_criterion.png"), gg_PDS_criterion)
ggsave(file.path(plot_dir, "gg_PDS_ACC.png"), gg_PDS_ACC)
ggsave(file.path(plot_dir, "gg_age_ACC.png"), gg_age_ACC)
ggsave(file.path(plot_dir, "gg_age_RT.png"), gg_age_RT)
ggsave(file.path(plot_dir, "gg_PDS_RT.png"), gg_PDS_RT)
ggsave(file.path(plot_dir, "gg_age_RT_sd.png"), gg_age_RT_sd)
ggsave(file.path(plot_dir, "gg_PDS_RT_sd.png"), gg_PDS_RT_sd)
ggsave(file.path(plot_dir, "gg_age_wsls.png"), gg_age_wsls)
ggsave(file.path(plot_dir, "gg_PDS_wsls.png"), gg_PDS_wsls)
ggsave(file.path(plot_dir, "gg_age_rewhist.png"), gg_age_rewhist)
ggsave(file.path(plot_dir, "gg_PDS_rewhist.png"), gg_PDS_rewhist)
ggsave(file.path(plot_dir, "gg_age_RT_slope.png"), gg_age_RT_slope)
ggsave(file.path(plot_dir, "gg_age_n_blocks.png"), gg_age_n_blocks)
ggsave(file.path(plot_dir, "gg_PDS_n_blocks.png"), gg_PDS_n_blocks)
ggsave(file.path(plot_dir, "gg_age_overall_stay.png"), gg_age_overall_stay)
ggsave(file.path(plot_dir, "gg_PDS_overall_stay.png"), gg_PDS_overall_stay)
```
```{r Start button}
```
