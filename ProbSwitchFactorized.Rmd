---
title: "ProbSwitchFactorized"
output: html_notebook
---

# Define functions
## Read in and clean data

```{r Read in ages}
get_ages = function(ages_file_dir) {
  
  ages = read.csv(ages_file_dir)
  colnames(ages)[colnames(ages) == "ID"] = "sID"
  
  # subset(ages, !Gender %in% c(1, 2))  # IDs 307 & 336 are "3"?! asked Sarah 3/19/2019
  # subset(ages, is.na(Columbia_cat))  # subjects 11-16, 34 and 55 are missing PDS
  # subset(ages, Gender==1 & PDS >3.5)  # we only have 1 boy with PDS > 3.5, but 22 girls
  
  ages$Gender = factor(ages$Gender, levels=c(2, 1, 3), labels=c("Female", "Male", NA))
  
  ages$Columbia_cat[ages$sID >= 300] = 10  # community adults (25-30)
  ages$Columbia_cat[ages$sID >= 400] = 9  # Berkeley undergrads (ca. 17-25)
  ages$Columbia_cat = factor(ages$Columbia_cat, labels=c("Pre", "Pub", "Post", "UCB", "Adult", NA))
  
  # Add testost. group
  ages$T134 = rowMeans(subset(ages, select=c(T1, T3, T4)), na.rm=T)
  ages$log_T = log(ages$T134)
  ggplot(ages, aes(T134, fill=Gender)) + geom_histogram(bins=15, position = position_dodge())
  
  make_groups = function(ages, colname, probs=c(1, 3/4, 2/4, 1/4)) {
    
    quantiles_f = quantile(ages[ages$sID < 300 & ages$Gender=="Female", colname], probs=probs, na.rm=T)
    quantiles_m = quantile(ages[ages$sID < 300 & ages$Gender=="Male", colname], probs=probs, na.rm=T)
    
    groups = rep(NA, nrow(ages))
    for (i in 1:length(probs)) {
      groups[ages$Gender=="Female" & ages[,colname] <= quantiles_f[i]] = paste0(round(100*probs[i], digits=1), "%")
      groups[ages$Gender=="Male" & ages[,colname] <= quantiles_m[i]] = paste0(round(100*probs[i], digits=1), "%")
    }
    groups[ages$sID >= 300] = "Adult"
    groups[ages$sID >= 400] = "UCB"
    # groups = factor(groups, levels=c("33.3%", "66.7%", "100%", "UCB", "Adult"))
    groups = factor(groups, levels=c("25%", "50%", "75%", "100%", "UCB", "Adult"))
    
    return(groups)
  }
  
  ages$T_group = make_groups(ages, "T134")
  ages$PDS_group = make_groups(ages, "PDS")
  ages$age_group = make_groups(ages, "PreciseYrs")
  ages$PDS[ages$age_group == 'Adult'] = 10
  ages$PDS[ages$age_group == 'UCB'] = 9
  ages$PDS = as.numeric(ages$PDS)
  
  ddply(ages, .(T_group, Gender), T=min(T134, na.rm=T), summarize)  # check that assignment was right (min matches up with quantiles)
  
  ggplot(ages, aes(Columbia_cat)) +
    geom_histogram(stat="count") +
    facet_grid(~ Gender)
  
  ggplot(ages, aes(PDS)) +
    geom_histogram() +
    facet_grid(~ Gender)
  
  return(ages)
}
```
```{r Read in data}
get_data = function(data_dir, data_name, patt) {
  all_files = data.frame()
  
  filenames = list.files(data_dir, pattern = patt)
  print(paste(length(filenames), "filenames on the list."))
  filename = filenames[1]  # debugging
  
  for(filename in filenames) {  # for debugging [100:200]
    
    if (data_name == "human") {
      mat_file = readMat(file.path(data_dir, filename))$exp[,,1]$PROBSWITCHdata[,,1]
      subj_file = data.frame(RT = t(mat_file$RT))
      subj_file$selected_box = (t(mat_file$key) - 10) / 2  # recode to make key left==0 and key right==1 (initially key right==12; key left==10)
      subj_file$reward = t(mat_file$reward)  # reward==1, no reward==0
      subj_file$correct_box = 1 - t(mat_file$better.box.left)  # recode to make left==0 and right==1 (initially the opposite)
      sID = as.numeric(strsplit(strsplit(filename, split = "PROBSWITCH_")[[1]][2], ".mat")[[1]])
      subj_file$sID = sID
      subj_file = subset(subj_file, !is.nan(reward) & selected_box %in% c(0, 1))  # remove no-response trials
      subj_file = subj_file[47:nrow(subj_file),]  # needs to be changed for future participants - 51
    } else {
      subj_file = read.csv(file.path(data_dir, filename))
    }
    
    # Make sure all files have the same columns
    ## Remove unwanted columns
    for (col_name in colnames(subj_file)) {
      if (!col_name %in% desired_columns) {
        subj_file[,col_name] = NULL
      }
    }
    ## Add NA columns for wanted columns
    for (col_name in desired_columns) {
      if (!col_name %in% colnames(subj_file)) {
        subj_file[,col_name] = NA
      }
    }
    if (is.na(subj_file$model_name[1])) {
      subj_file$model_name = subj_file$learning_style
    }
    if (is.na(subj_file$model_name[1])) {
      subj_file$model_name = "no_model"
    }
    if (is.na(subj_file$version[1])) {
      subj_file$version = "no_version"
    }
    
    # Add columns
    subj_file$TrialID = 1:nrow(subj_file)
    subj_file$rewardversion = subj_file$sID %% 4
    subj_file$ACC = with(subj_file, selected_box == correct_box)
    
    # Get switch_trial, block, and trialssinceswitch
    this_trial = subj_file$correct_box[2:nrow(subj_file)]
    prev_trial = subj_file$correct_box[1:(nrow(subj_file) - 1)]
    subj_file$switch_trial = c(F, this_trial != prev_trial)
    subj_file$block = cumsum(subj_file$switch_trial)
    
    subj_file$trialsinceswitch = NA
    for (blocki in subj_file$block) {
      n_rows = nrow(subset(subj_file, block == blocki))
      if (n_rows >= 4) {
        subj_file$trialsinceswitch[subj_file$block == blocki] = 0:(n_rows - 1)
        subj_file$trialsinceswitch[subj_file$block == blocki][(n_rows - 3):n_rows] = -4:-1
      }
    }
    
    subj_file$outcome_1_back = c(NA, subj_file$reward[1:(nrow(subj_file) - 1)])
    subj_file$outcome_2_back = c(NA, NA, subj_file$reward[1:(nrow(subj_file) - 2)])
    
    subj_file$choice_left = subj_file$selected_box == 0  # left: 0; right: 1
    subj_file$choice_1_back = c(NA, subj_file$choice_left[1:(nrow(subj_file) - 1)])
    subj_file$choice_2_back = c(NA, NA, subj_file$choice_left[1:(nrow(subj_file) - 2)])
    
    if (data_name == "human") {
      write.csv(subj_file, paste(data_dir, "/PS_", sID, ".csv", sep = ""), row.names = F)
    }
    
    all_files = as.data.frame(rbind(all_files, subj_file))
  }
  
  reward_versions = ddply(all_files, .(sID), summarize, rewardversion = rewardversion[1])
  write.csv(reward_versions, paste0(data_dir, "_rewardversions.csv"))
  print(paste("Read in data from", length(unique(all_files$sID)), "unique subjects (might be more simulations)."))
  summary(all_files)
  summary(subj_file)
  colnames(all_files)
  
  return(all_files)
}
```
```{r Remaining fixes for all_filess}
finish_all_files = function(all_files, ages) {
  
  all_files$outcome_21_back = paste(all_files$outcome_2_back, all_files$outcome_1_back)
  all_files$outcome_21_back = factor(all_files$outcome_21_back,
                                     levels = c("1 1", "0 1", "1 0", "0 0"),
                                     labels = c("both reward", "no reward, reward", "reward, no reward", "both no reward"))
  all_files$same_choice_01_back = all_files$choice_left == all_files$choice_1_back  # same choice in this trial as in the last?
  all_files$same_choice_12_back = all_files$choice_1_back == all_files$choice_2_back  # same choice in this trial as in the last?
  all_files$choice_12_back = ifelse(all_files$choice_1_back, "left", "right")
  all_files$choice_12_back[!all_files$same_choice_12_back | is.na(all_files$same_choice_12_back)] = NA
  all_files$reward_port = factor(all_files$correct_box, levels = c(0, 1), labels = c("Left", "Right"))
  all_files$learning_style = factor(all_files$learning_style)
  
  old_nrows = nrow(all_files)
  # orig_all_files = all_files
  all_files = merge(all_files, ages, all.x = T)
  all_files$PDS = as.numeric(all_files$PDS)
  # all_files$Columbia_cat = factor(all_files$Columbia_cat)
  # all_files$age_group = as.character(all_files$age_group)
  # all_files$age_group = factor(as.character(all_files$age_group), levels = c("8-10", "11-14", "15-17", "25-30"))
  assertthat::assert_that(nrow(all_files) == old_nrows)
  # summary(all_files)
  
  xyz = ddply(all_files, .(sID, Gender, age_group), x = NA, summarize)
  ddply(xyz, .(age_group, Gender), summarize, n=length(age_group))
  
  # stay
  stay = with(all_files, c(choice_left == choice_1_back))
  all_files$stay = c(stay[2:length(stay)], NA)
  all_files$stay[all_files$TrialID == 1] = NA  # first trial is no stay
  
  return(all_files)
}
```
```{r get_wsls}
get_wsls = function(all_files) {
  wsls_pre = ddply(all_files, .(sID, Gender, version, reward, age_group), summarize,
               stay = mean(stay, na.rm = T))
  wsls = ddply(wsls_pre, .(sID, Gender, reward, age_group), summarize,
               stay = mean(stay, na.rm = T))
  wsls$reward = factor(wsls$reward)
  
  return(wsls)
}
```
```{r get_all_files_sum}
get_all_files_sum = function(all_files) {
  
  all_files_sum_pre = ddply(subset(all_files, !is.na(choice_12_back)),
                        .(sID, version, age_group, Columbia_cat, T_group, model_name, outcome_21_back, choice_12_back), summarize,
                        choice_left = mean(choice_left, na.rm = T))
  all_files_sum = ddply(all_files_sum_pre,
                        .(sID, age_group, Columbia_cat, T_group, model_name, outcome_21_back, choice_12_back), summarize,
                        choice = mean(choice_left, na.rm = T))
  
  return(all_files_sum)
}

# subset(all_files, select = c("sID", "TrialID", "choice_left", "choice_1_back", "stay", "choice_2_back", "same_choice_01_back", "outcome_21_back", "choice_12_back", "reward"))
```
```{r get_ACC_reward_subj}
get_ACC_reward_subj = function(all_files) {
    
  ACC_subj = ddply(all_files,
                   .(sID, Gender, T_group, log_T, age_group, PDS_group, PDS, PreciseYrs, Columbia_cat, trialsinceswitch, model_name), summarize,
                   ACC = mean(ACC, na.rm=T))  # to make sure error bars are right
  reward_subj = ddply(subset(all_files, !is.na(outcome_21_back) & !is.na(choice_12_back)),
                      .(sID, Gender, PDS, T_group, PDS_group, log_T, Columbia_cat, outcome_21_back, age_group, model_name, PreciseYrs), summarize,
                      stay = mean(same_choice_01_back, na.rm = T))
  
  # Overall behavior for each participant
  ACCs = ddply(all_files, .(sID, PreciseYrs, Gender, PDS, age_group), summarize,
               mean_ACC = mean(ACC, na.rm=T),
               mean_reward = mean(reward, na.rm=T),
               mean_stay = mean(stay, na.rm=T),
               n_switches=sum(switch_trial, na.rm=T),
               n_fast_RTs=sum(RT<100, na.rm=T),
               # median_RT=median(RT, na.rm=T),
               n_trials=length(RT))
  ACCs$median_cor_RT = ddply(subset(all_files, ACC==T), .(sID, PreciseYrs, Gender, PDS, age_group), summarize,
               median_cor_RT = median(RT, na.rm=T))$median_cor_RT
  
  
  return(list(ACC_subj, reward_subj, ACCs))
}
```

## Describing the sample

```{r}
plot_sample_composition = function(all_files, gg_save, run_regression) {
  
  # Sample composition
  gg_PDS_composition =
    ggplot(ddply(all_files, .(sID, PDS, Gender, T134, PreciseYrs), summarize, z=NA), aes(x=factor(1), fill=factor(round(PDS*4)/4))) +
    geom_bar(width=1) + coord_polar("y") +
    labs(fill="PDS") +
    facet_grid(~ Gender)
  
  gg_age_composition = gg_PDS_composition + aes(fill=factor(round(PreciseYrs))) + labs(fill="Age")
  gg_T_composition = gg_PDS_composition + aes(fill=factor(round(log(T134)*3)/3)) + labs(fill="log. Testost.")
  
  # Relationship between predictors
  dat = subset(ages, sID < 300)
  gg_age_PDS = ggplot(dat, aes(PreciseYrs, PDS, color=Gender)) +
    geom_point(size=0.4) +
    scale_color_manual(values=c("red", "orange")) +
    labs(x="Age", y="PDS", color="Sex")
  gg_age_T = gg_age_PDS + aes(PreciseYrs, log_T) + labs(x="Age", y="Testost.", color="Sex")
  gg_PDS_T = gg_age_PDS + aes(PDS, log_T) + labs(x="PDS", y="Testost.", color="Sex")
  
  if (run_regression) {
    for (gender in levels(dat$Gender)[1:2]) {
      print(gender)
      dat_ = subset(dat, Gender==gender)
      print(cor.test(dat_$PreciseYrs, dat_$log_T))
      print(cor.test(dat_$PreciseYrs, dat_$PDS))
      print(cor.test(dat_$log_T, dat_$PDS))
    }
  }
  
  if (gg_save) {
    if (data_name %in% c("human", "fitted_human")) {
      ggsave(file.path(plot_dir, "/gg_PDS_composition.png"), gg_PDS_composition, width=4, height=2)
      ggsave(file.path(plot_dir, "/gg_age_composition.png"), gg_age_composition, width=4, height=2)
      ggsave(file.path(plot_dir, "/gg_T_composition.png"), gg_T_composition, width=6, height=3)
      png(file.path(plot_dir, "/yrs_age_T_pair_plot.png"))
      pairs(ages[ages$sID < 300, c("PreciseYrs", "PDS", "log_T")], pch = 19, lower.panel=NULL, col=ages$Gender)
      dev.off()
      ggsave(file.path(plot_dir, "/gg_age_PDS.png"), gg_age_PDS, width=3, height=2)
      ggsave(file.path(plot_dir, "/gg_age_T.png"), gg_age_T, width=3, height=2)
      ggsave(file.path(plot_dir, "/gg_PDS_T.png"), gg_PDS_T, width=3, height=2)
      
      ggsave(file.path(plot_dir, "/gg_PDS_composition.svg"), gg_PDS_composition, width=4, height=2)
      ggsave(file.path(plot_dir, "/gg_age_composition.svg"), gg_age_composition, width=4, height=2)
      ggsave(file.path(plot_dir, "/gg_T_composition.svg"), gg_T_composition, width=6, height=3)
      svg(file.path(plot_dir, "/yrs_age_T_pair_plot.svg"))
      pairs(ages[ages$sID < 300, c("PreciseYrs", "PDS", "log_T")], pch = 19, lower.panel=NULL, col=ages$Gender)
      dev.off()
      ggsave(file.path(plot_dir, "/gg_age_PDS.svg"), gg_age_PDS, width=3, height=2)
      ggsave(file.path(plot_dir, "/gg_age_T.svg"), gg_age_T, width=3, height=2)
      ggsave(file.path(plot_dir, "/gg_PDS_T.svg"), gg_PDS_T, width=3, height=2)
    }
  }
}
```

## Analyzing behavior

```{r Performance over age}
plot_performance_over_age = function(ACCs, gg_save) {

  # Correct over age
  gg_ACC_age = ggplot(ACCs, aes(PreciseYrs, mean_ACC, color=Gender)) +
    geom_point() +
    geom_smooth()
  
  # Stay over age
  gg_stay_age = gg_ACC_age + aes(y=mean_stay)
  
  # Coins won across age
  gg_reward_age = gg_ACC_age + aes(y=mean_reward * 150)
  
  # RTs across age
  gg_RT_age = gg_ACC_age + aes(y=median_cor_RT)
  
  # Number of switches across age
  gg_switch_age = gg_ACC_age + aes(y=n_switches)
  
  if (gg_save) {
    ggsave(file.path(plot_dir, "/gg_age_ACC.png"), gg_ACC_age)
    ggsave(file.path(plot_dir, "/gg_age_stay.png"), gg_stay_age)
    ggsave(file.path(plot_dir, "/gg_age_reward.png"), gg_reward_age)
    ggsave(file.path(plot_dir, "/gg_age_RT.png"), gg_RT_age)
    ggsave(file.path(plot_dir, "/gg_age_switch.png"), gg_switch_age)
  }
}

```

```{r Count switches for each participant}
plot_indivduals_for_exclusion = function(all_files, gg_save, exclude_UCB) {
  
  # Overall behavior for each participant
  ACCs = ddply(all_files, .(sID, PreciseYrs, Gender, PDS, T1, age_group), summarize,
               mean_ACC = mean(ACC, na.rm=T),
               n_switches=sum(switch_trial, na.rm=T),
               n_fast_RTs=sum(RT<100, na.rm=T),
               mean_RT=mean(RT, na.rm=T),
               n_trials=length(RT))
  
  mean(ACCs$n_switches)
  sd(ACCs$n_switches)
  
  # Sort by ACC
  ACCs = ACCs[order(ACCs$mean_ACC),]
  ACCs$ACC_ix = 1:nrow(ACCs)
  
  # Sort by number of switches
  ACCs = ACCs[order(ACCs$n_switches),]
  ACCs$switch_ix = 1:nrow(ACCs)
  
  # Sort by number of <100msec trial
  ACCs = ACCs[order(ACCs$n_fast_RTs),]
  ACCs$fast_ix = 1:nrow(ACCs)
  
  # Plot each one
  gg_0excl_ACC = ggplot(ACCs, aes(ACC_ix, mean_ACC, color=PreciseYrs)) +
    geom_point()
  
  gg_0excl_switch = ggplot(ACCs, aes(switch_ix, n_switches, color=PreciseYrs)) +
    geom_point()
  
  gg_0excl_fast = ggplot(ACCs, aes(fast_ix, n_fast_RTs, color=PreciseYrs)) +
    geom_point()
  
  # Tell us who'll be excluded
  special_excl = 1004
  gender_excl = sort(subset(ACCs, is.na(Gender))$sID)
  PDS_excl = sort(subset(ACCs, is.na(PDS) & sID < 400)$sID)
  T_excl = sort(subset(ACCs, is.na(T1) & sID < 400)$sID)
  age_excl = sort(subset(ACCs, is.na(age))$sID)
  n_trials_excl = sort(subset(ACCs, n_trials < 120)$sID)
  switch_excl = sort(subset(ACCs, n_switches < 5)$sID)
  ACC_excl = sort(subset(ACCs, mean_ACC < 0.58)$sID)
  above30_excl = sort(subset(ACCs, PreciseYrs > 30)$sID)
  if (exclude_UCB) {
    above30_excl = c(above30_excl, subset(ACCs, sID > 400)$sID)
  }
  print("Excluding subjetct 1004.")
  print(paste("Participants missing gender:", paste(gender_excl, collapse=', '), "unsorted Ages:", paste(subset(ACCs, sID %in% gender_excl)$PreciseYrs, collapse=', ')))
  # print(paste("Participants missing PDS:", paste(PDS_excl, collapse=', '), "unsorted Ages:", paste(subset(ACCs, sID %in% PDS_excl)$PreciseYrs, collapse=', ')))
  # print(paste("Participants missing T:", paste(T_excl, collapse=', '), "unsorted Ages:", paste(subset(ACCs, sID %in% T_excl)$PreciseYrs, collapse=', ')))
  print(paste("Participants with < 120 trials:", paste(n_trials_excl, collapse=', '), "unsorted Ages:", paste(subset(ACCs, sID %in% n_trials_excl)$PreciseYrs, collapse=', ')))
  print(paste("Participants with n_switches < 5:", paste(switch_excl, collapse=', '), "unsorted Ages:", paste(subset(ACCs, sID %in% switch_excl)$PreciseYrs, collapse=', ')))
  print(paste("Participants with mean_ACC < 0.58:", paste(ACC_excl, collapse=', '), "unsorted Ages:", paste(subset(ACCs, sID %in% ACC_excl)$PreciseYrs, collapse=', ')))
  print(paste("Participants > 30:", paste(above30_excl, collapse=', '), "unsorted Ages:", paste(subset(ACCs, sID %in% above30_excl)$PreciseYrs, collapse=', ')))
  all_excluded = unique(c(gender_excl, n_trials_excl, switch_excl, ACC_excl, above30_excl, special_excl))  # , PDS_excl, T_excl
  
  # Save plots
  if (gg_save) {
    ggsave(file.path(plot_dir, "/gg_0excl_ACC.png"), gg_0excl_ACC)
    ggsave(file.path(plot_dir, "/gg_0excl_switch.png"), gg_0excl_switch)
    ggsave(file.path(plot_dir, "/gg_0excl_fast.png"), gg_0excl_fast)
    
    ggsave(file.path(plot_dir, "/gg_0excl_ACC.svg"), gg_0excl_ACC)
    ggsave(file.path(plot_dir, "/gg_0excl_switch.svg"), gg_0excl_switch)
    ggsave(file.path(plot_dir, "/gg_0excl_fast.svg"), gg_0excl_fast)
  }
  
  return(all_excluded)
}
```
```{r Basic behavioral analyses}
plot_RTs_ACC_choice_rewards_stay = function(all_files, ACC_subj, reward_subj, all_files_sum, gg_save) {
  
  # Response times
  gg_RT = ggplot(all_files, aes(TrialID, RT, fill = age_group)) +
    # geom_point() +
    stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1), geom = "bar", position = position_dodge(width = 0.9)) +
    facet_grid(~ age_group)
  # gg_RT_PDS = gg_RT + aes(fill=Columbia_cat) + facet_grid(~ Columbia_cat)
  
  all_files_sum2_pre = ddply(subset(all_files, !is.na(trialsinceswitch)),
                         .(sID, version, age_group, T_group, model_name, trialsinceswitch), summarize,
                         choice_left = mean(choice_left, na.rm = T),
                         RT = median(RT, na.rm = T))
  all_files_sum2 = ddply(all_files_sum2_pre,
                         .(sID, age_group, T_group, model_name, trialsinceswitch), summarize,
                         choice = mean(choice_left, na.rm = T),
                         RT = median(RT, na.rm = T))
  gg_RTt = ggplot(all_files_sum2, aes(trialsinceswitch, RT, fill = age_group)) +
    stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1), geom = "bar", position = position_dodge(width = 0.9)) +
    stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1), geom = "errorbar", width=0, position = position_dodge(width = 0.9)) +
    # geom_point(alpha = .3, position = "jitter") +
    coord_cartesian(x = c(-3, 5)) +
    facet_grid(~ age_group)
  
  # ACC over trials
  gg_ACC = ggplot(all_files, aes(TrialID, 100 * as.numeric(ACC), fill = age_group)) +
    stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1), geom = "bar") +
    labs(y = "% correct", fill = "Age") +
    facet_grid(model_name ~ age_group)
  
  # Choice over blocks
  gg_choice_blocks = ggplot(subset(all_files, !is.na(choice_left)),
                         aes(trialsinceswitch, 100 * choice_left, color = reward_port, group = reward_port, shape = age_group)) +
    stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1), geom = "errorbar", width=0) +
    stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1), geom = "line") +
    geom_vline(xintercept = 0, linetype = "dotted") +
    coord_cartesian(x = c(-3, 7)) +
    labs(x = "Trials since switch", y = "% choice left", color = "Reward port", shape = "") +
    facet_grid(model_name ~ age_group)
  # gg_choice_blocks_PDS = gg_choice_blocks + aes(shape=factor(Columbia_cat)) + facet_grid(model_name ~ Columbia_cat)
  
  # ACC over blocks
  gg_ACC_blocks =
    ggplot(ACC_subj, aes(trialsinceswitch, 100 * ACC, group = age_group, color = age_group)) + 
    stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1), geom = "errorbar", width=0, color='grey') +
    stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1), geom = "line") +
    geom_vline(xintercept = 0, linetype = "dotted") +
    coord_cartesian(x = c(-3, 7), y = c(0, 100)) +
    scale_x_continuous(breaks = seq(-3, 7, 2)) +
    # scale_color_brewer(palette='Blues') +
    scale_color_manual(values=colors_3and1) +
    labs(x = "Trials since switch", y = "% correct", color = "Age", shape = "Age") +
    facet_grid(Gender ~ model_name)
  gg_ACC_blocks_PDS = gg_ACC_blocks + aes(group=PDS_group, color=PDS_group) + labs(color="PDS")
  gg_ACC_blocks_T = gg_ACC_blocks + aes(group=T_group, color=T_group) + labs(color="Testost.")
  gg_ACC_blocks_T$data = subset(gg_ACC_blocks$data, !is.na(T_group))
  
  dat1 = subset(ACC_subj, trialsinceswitch == 1)
  # t.test(ACC ~ age_group, data=subset(dat1, age_group %in% c("7-12", "25-30")))
  # t.test(ACC ~ age_group, data=subset(dat1, age_group %in% c("7-12", "13-17")))
  # t.test(ACC ~ age_group, data=subset(dat1, age_group %in% c("13-17", "25-30")))
  # summary(lm(ACC ~ PreciseYrs, dat=subset(dat1, PreciseYrs<24)))  # quadratic effect?
  
  dat37 = subset(ACC_subj, trialsinceswitch %in% c(3, 4, 5, 6, 7))
  dat37 = ddply(dat37, .(sID, age_group, PreciseYrs), summarize, ACC=mean(ACC,na.rm=T))
  # t.test(ACC ~ age_group, data=subset(dat37, age_group %in% c("7-12", "25-30")))
  # t.test(ACC ~ age_group, data=subset(dat37, age_group %in% c("7-12", "13-17")))
  # t.test(ACC ~ age_group, data=subset(dat37, age_group %in% c("13-17", "25-30")))
  # summary(lm(ACC ~ PreciseYrs, dat=subset(dat37, PreciseYrs<24)))  # quadratic effect?
  
  # Response times
  gg_RT_blocks = gg_choice_blocks + aes(y = RT) + coord_cartesian(x = c(-3, 7), y = c(250, 650))
  
  # Rewards over trials
  gg_rewards = ggplot(all_files, aes(TrialID, 100 * reward, fill = age_group)) +
    stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1), geom = "bar") +
    labs(y = "% reward received", fill = "Age") +
    facet_grid(model_name ~ age_group)
  
  # Choice depending on previous outcome
  gg_rewards2 = ggplot(subset(all_files_sum, !is.na(choice_12_back)),
                       aes(outcome_21_back, 100 * choice, fill = choice_12_back, group = choice_12_back, shape = age_group)) +
    stat_summary(fun.data = mean_cl_normal, geom = "bar", fun.args = list(mult = 1), position = "dodge") +
    stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width=0, fun.args = list(mult = 1), position = position_dodge(0.9)) +
    coord_cartesian(y = c(0, 100)) +
    theme(axis.text.x = element_text(angle = -90, hjust = 0)) +
    labs(x = "Reward history (1 trial back, 2 trials back)", y = "% left choice", fill = "Previous two choices", shape = "Age") +
    facet_grid(model_name ~ age_group)
  # gg_rewards2_PDS = gg_rewards2 + aes(shape=factor(Columbia_cat)) + facet_grid(model_name ~ Columbia_cat)
  
  # Choice depending on previous outcome (collapsed)
  # sub = subset(all_files, !is.na(outcome_21_back), select = c("sID", "TrialID", "choice_left", "choice_1_back", "stay", "same_choice_01_back", "outcome_21_back"))
  # sub[order(sub$sID, sub$TrialID), ]
  
  # summary(lmer(same_choice_01_back ~ PreciseYrs + (1 | sID), subset(all_files, outcome_21_back=='both reward')))
  # summary(lmer(same_choice_01_back ~ PreciseYrs + (1 | sID), subset(all_files, outcome_21_back=='no reward, reward')))
  # summary(lmer(same_choice_01_back ~ PreciseYrs + (1 | sID), subset(all_files, outcome_21_back=='both no reward')))

  stay_plot =
    ggplot(reward_subj, aes(outcome_21_back, 100 * stay, fill = age_group)) +
    stat_summary(fun.data = mean_cl_normal, geom = "bar", fun.args = list(mult = 1), position = "dodge") +
    stat_summary(fun.data = mean_cl_normal, geom = "errorbar", fun.args = list(mult = 1), position = position_dodge(0.9), width=0) +  # or "pointrante" with size=.02
    theme(axis.text.x = element_text(angle = -30, hjust = 0.2)) +
    coord_cartesian(ylim = c(0, 100)) +
    scale_fill_manual(values=colors_3and1) +
    labs(x = "Previous outcomes", y = "% stay", fill = "Age") +
    facet_grid(Gender ~ model_name)
  stay_plot_PDS = stay_plot + aes(group=PDS_group, fill=PDS_group) + labs(fill="PDS")
  stay_plot_T = stay_plot + aes(group=T_group, fill=T_group) + labs(fill="Testost.")  # make sure i'm not introducing NAs: mean(is.na(log(all_files$log_T)) == is.na(all_files$log_T))
  stay_plot_T$data = subset(stay_plot$data, !is.na(T_group))
  
  if (gg_save) {
    if (data_name %in% c("human", "fitted_human")) {
      ggsave(file.path(plot_dir, "/gg_RT.png"), gg_RT)
      ggsave(file.path(plot_dir, "/gg_RTt.png"), gg_RTt)
      ggsave(file.path(plot_dir, "/gg_RT_blocks.png"), gg_RT_blocks, width = 8, height = 3)
    }
    ggsave(file.path(plot_dir, "/gg_ACC.png"), gg_ACC)
    ggsave(file.path(plot_dir, "/gg_choice_blocks.png"), gg_choice_blocks, width = 8, height = 1 + 2 * length(unique(gg_choice_blocks$data$model_name)))
    ggsave(file.path(plot_dir, "/gg_rewards.png"), gg_rewards)
    ggsave(file.path(plot_dir, "/gg_rewards2.png"), gg_rewards2, width = 8, height = 1.4 + 2 * length(unique(gg_ACC_blocks$data$model_name)))
    ggsave(file.path(plot_dir, "/gg_ACC_blocks.png"), gg_ACC_blocks, width = 3.3, height = 2 + length(unique(gg_ACC_blocks$data$model_name)))
    ggsave(file.path(plot_dir, "/gg_ACC_blocks_PDS.png"), gg_ACC_blocks_PDS, width = 3.3, height = 2 + length(unique(gg_ACC_blocks$data$model_name)))
    ggsave(file.path(plot_dir, "/gg_ACC_blocks_T.png"), gg_ACC_blocks_T, width = 3.3, height = 2 + length(unique(gg_ACC_blocks$data$model_name)))
    ggsave(file.path(plot_dir, "/stay_plot.png"), stay_plot, width = 3.3, height = 2.2 + length(unique(stay_plot$data$model_name)))
    ggsave(file.path(plot_dir, "/stay_plot_PDS.png"), stay_plot_PDS, width = 3.3, height = 2.2 + length(unique(stay_plot$data$model_name)))
    ggsave(file.path(plot_dir, "/stay_plot_T.png"), stay_plot_T, width = 3.3, height = 2.2 + length(unique(stay_plot$data$model_name)))
    
    if (data_name %in% c("human", "fitted_human")) {
      ggsave(file.path(plot_dir, "/gg_RT.svg"), gg_RT)
      ggsave(file.path(plot_dir, "/gg_RTt.svg"), gg_RTt)
      ggsave(file.path(plot_dir, "/gg_RT_blocks.svg"), gg_RT_blocks, width = 8, height = 3)
    }
    ggsave(file.path(plot_dir, "/gg_ACC.svg"), gg_ACC)
    ggsave(file.path(plot_dir, "/gg_choice_blocks.svg"), gg_choice_blocks, width = 8, height = 1 + 2 * length(unique(gg_choice_blocks$data$model_name)))
    ggsave(file.path(plot_dir, "/gg_rewards.svg"), gg_rewards)
    ggsave(file.path(plot_dir, "/gg_rewards2.svg"), gg_rewards2, width = 8, height = 1.4 + 2 * length(unique(gg_ACC_blocks$data$model_name)))
    ggsave(file.path(plot_dir, "/gg_ACC_blocks.svg"), gg_ACC_blocks, width = 3.3, height = 2 + length(unique(gg_ACC_blocks$data$model_name)))
    ggsave(file.path(plot_dir, "/gg_ACC_blocks_PDS.svg"), gg_ACC_blocks_PDS, width = 3.3, height = 2 + length(unique(gg_ACC_blocks$data$model_name)))
    ggsave(file.path(plot_dir, "/gg_ACC_blocks_T.svg"), gg_ACC_blocks_T, width = 3.3, height = 2 + length(unique(gg_ACC_blocks$data$model_name)))
    ggsave(file.path(plot_dir, "/stay_plot.svg"), stay_plot, width = 3.3, height = 2.2 + length(unique(stay_plot$data$model_name)))
    ggsave(file.path(plot_dir, "/stay_plot_PDS.svg"), stay_plot_PDS, width = 3.3, height = 2.2 + length(unique(stay_plot$data$model_name)))
    ggsave(file.path(plot_dir, "/stay_plot_T.svg"), stay_plot_T, width = 3.3, height = 2.2 + length(unique(stay_plot$data$model_name)))
  }
}
```
```{r Following up on switch trials}
plot_switch_age_T_PDS = function(ACC_subj, reward_subj, run_regression, gg_save) {
  
  gg_ACC1trialswitch_age =
    ggplot(subset(ACC_subj, trialsinceswitch==1 & PreciseYrs < 20), aes(PreciseYrs, ACC, color=Gender)) +
    geom_point() +
    labs(y="Acc trial 1 after swtich") +
    geom_smooth(method='lm')
  gg_ACC1trialswitch_PDS = gg_ACC1trialswitch_age + aes(PDS)
  gg_ACC1trialswitch_T = gg_ACC1trialswitch_age + aes(log_T)
  
  kid_rewnorew_dat = subset(reward_subj, outcome_21_back=='reward, no reward' & PDS < 6)
  gg_stayrewnorew_PDS = ggplot(kid_rewnorew_dat, aes(PDS, stay)) +
    geom_point() +
    geom_smooth(method='lm', color='darkgrey') +
    labs(y="% stay after 'reward, no reward'") +
    facet_grid(~ Gender)
  gg_stayrewnorew_age = gg_stayrewnorew_PDS + aes(PreciseYrs, stay)
  gg_stayrewnorew_T = gg_stayrewnorew_PDS + aes(log_T, stay)
  
  gg_11to14_PDS = 
    ggplot(subset(kid_rewnorew_dat, PreciseYrs >= 11 & PreciseYrs <= 14), aes(PDS, stay, color=Gender)) +
    geom_point() +
    geom_smooth(method='lm') +
    labs(x="PDS", y="% stay after 'reward, no reward'")
  gg_11to14_T = gg_11to14_PDS + aes(log_T)
  
  # summary(glmer(ACC ~ PreciseYrs_z * T1_z + (1 | sID) + (1 | Gender), reg_dat, binomial))
  if (run_regression) {
    for (gender in levels(all_files$Gender)[1:2]) {
      print(gender)
      print(summary(glmer(stay ~ PreciseYrs + PDS + log_T + (1 | sID) + (1 | Gender), subset(all_files, outcome_21_back=='reward, no reward' & sID < 300), binomial)))
      print(summary(glmer(stay ~ PreciseYrs + PDS + log_T + (1 | sID), subset(all_files, outcome_21_back=='reward, no reward' & Gender==gender & sID < 300), binomial)))
      print(summary(lmer(stay ~ PreciseYrs + PDS + log_T + (1 | Gender), kid_rewnorew_dat)))
      print(summary(lm(stay ~ PreciseYrs + PDS + log_T, subset(kid_rewnorew_dat, Gender==gender))))
    }
  }
  
  if (gg_save) {
    if (data_name %in% c("human", "fitted_human", "simulated_human")) {
      ggsave(file.path(plot_dir, "/gg_ACC1trialswitch_age.png"), gg_ACC1trialswitch_age)
      ggsave(file.path(plot_dir, "/gg_ACC1trialswitch_PDS.png"), gg_ACC1trialswitch_PDS)
      ggsave(file.path(plot_dir, "/gg_ACC1trialswitch_T.png"), gg_ACC1trialswitch_T)
      ggsave(file.path(plot_dir, "/gg_stayrewnorew_PDS.png"), gg_stayrewnorew_PDS)
      ggsave(file.path(plot_dir, "/gg_stayrewnorew_age.png"), gg_stayrewnorew_age)
      ggsave(file.path(plot_dir, "/gg_stayrewnorew_T.png"), gg_stayrewnorew_T)
      ggsave(file.path(plot_dir, "/gg_11to14_PDS.png"), gg_11to14_PDS)
      ggsave(file.path(plot_dir, "/gg_11to14_T.png"), gg_11to14_T)
      
      ggsave(file.path(plot_dir, "/gg_ACC1trialswitch_age.svg"), gg_ACC1trialswitch_age)
      ggsave(file.path(plot_dir, "/gg_ACC1trialswitch_PDS.svg"), gg_ACC1trialswitch_PDS)
      ggsave(file.path(plot_dir, "/gg_ACC1trialswitch_T.svg"), gg_ACC1trialswitch_T)
      ggsave(file.path(plot_dir, "/gg_stayrewnorew_PDS.svg"), gg_stayrewnorew_PDS)
      ggsave(file.path(plot_dir, "/gg_stayrewnorew_age.svg"), gg_stayrewnorew_age)
      ggsave(file.path(plot_dir, "/gg_stayrewnorew_T.svg"), gg_stayrewnorew_T)
      ggsave(file.path(plot_dir, "/gg_11to14_PDS.svg"), gg_11to14_PDS)
      ggsave(file.path(plot_dir, "/gg_11to14_T.svg"), gg_11to14_T)
    }
  }
}
```
```{r WSLS}
plot_wsls = function(wsls, gg_save) {
  
  gg_wsls = ggplot(wsls, aes(reward == 1, stay, color = reward == 1, shape = age_group)) +
    stat_summary(fun.data = "mean_se", geom = "errorbar", width=0, with=0) +
    geom_point(alpha = 0.5, position = "jitter") +
    labs(x = "Reward", y = "% stay trials", color = "Reward", shape = "Age") +
    facet_grid(Gender ~ age_group)
  if (data_name == "fitted_sim") {
    gg_wsls = gg_wsls + facet_grid(learning_style ~ method)
  }
  
  if (gg_save) {
    ggsave(file.path(plot_dir, "/gg_wsls.png"), gg_wsls)
    
    ggsave(file.path(plot_dir, "/gg_wsls.svg"), gg_wsls)
  }
}
```
```{r correlate params and behavior}
correlate_params_behavior = function(all_files, human_data_dir, model_name, gg_save) {
  
  # Get model parameters
  if (grepl("B", model_name)) {
    params = ddply(all_files, .(sID),
                   PreciseYrs=PreciseYrs[1], PDS=PDS[1], BMI=BMI[1], T1=T1[1],
                   beta=beta[1], persev=persev[1], p_switch=p_switch[1], p_reward=p_reward[1], summarize)
  } else if (grepl("RL", model_name)) {
    all_files$calpha_sc = with(all_files, calpha / alpha)
    all_files$cnalpha_sc = with(all_files, cnalpha / nalpha)
    params = ddply(all_files, .(sID),
                   PreciseYrs=PreciseYrs[1], PDS=PDS[1], BMI=BMI[1], T1=T1[1],
                   beta=beta[1], persev=persev[1], alpha=alpha[1], nalpha=nalpha[1], calpha_sc=calpha_sc[1], cnalpha_sc=cnalpha_sc[1], summarize)
  } else if (grepl("WSLS", model_name)) {
    params = ddply(all_files, .(sID),
                   PreciseYrs=PreciseYrs[1], PDS=PDS[1], BMI=BMI[1], T1=T1[1],
                   beta=beta[1], summarize)
  }
  
  # Load human data
  ages = get_ages(ages_file_dir)
  hum_files = get_data(human_data_dir, "human", ".*mat")
  hum_files = finish_all_files(hum_files, ages)
  
  # Exclude subjects
  excl_subj = plot_indivduals_for_exclusion(hum_files, gg_save)
  hum_files = subset(hum_files, !sID %in% excl_subj)
  
  # Get 1-number behavioral summaries
  reward_subj = get_ACC_reward_subj(hum_files)[[2]]
  switch_speed2 = subset(reward_subj, outcome_21_back=="reward, no reward", select=c("sID", "stay"))
  switch_speed3 = subset(reward_subj, outcome_21_back=="both no reward", select=c("sID", "stay"))
  colnames(switch_speed2) = c("sID", "StayRN")
  colnames(switch_speed3) = c("sID", "StayNN")
  mean_ACC = ddply(hum_files, .(sID), ACC=mean(ACC, na.rm=T), summarize)
  median_RT = ddply(subset(hum_files, ACC=T), .(sID), RTCorr=median(RT, na.rm=T), summarize)
  
  # Put everything into a single dataframe
  l = list(switch_speed2, switch_speed3, mean_ACC, median_RT)
  cor_dat = params
  for(i in 1:length(l)) {
    cor_dat = merge(cor_dat, l[[i]], by="sID", all.x=T, all.y=F)
  }
  cor_dat$sID = NULL
  colnames(cor_dat)[colnames(cor_dat)=="PreciseYrs"] = "Age"
  
  # Calculate the correlation matrix (rcorr in Hmisc also calculates p-values)
  cor_matrix = cor(cor_dat, use="complete.obs")
  p_values = cor.mtest(cor_dat, conf.level = .95)
  
  # Plot correlation heatmap
  library("corrplot")  # only loading corrplot so late because it seems to interfere with ddply
  if (gg_save) {
    col = colorRampPalette(rev(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA")))
    
    png(file.path(plot_dir, "/gg_corrplot.png"), pointsize=15, width=600, height=600)
    corrplot(cor_matrix, method="color", col=col(200),
         order="hclust", addrect=3, number.cex = 0.8, #type = "upper", 
         addCoef.col="black", # Add coefficient of correlation
         tl.col="black", tl.srt=30, cl.pos="b", # Text label, color, and rotation
         # Combine with significance
         p.mat = p_values$p, sig.level=0.05, insig="blank", 
         # hide correlation coefficient on the principal diagonal
         # diag = FALSE
         )
    # corrplot(cor_matrix, p.mat=p_values$p, method="color", order="hclust", insig="label_sig", pch="p" addrect=4)
    # corrplot(cor_matrix, type="upper", tl.col="black", tl.srt=45)
    dev.off()
    
    svg(file.path(plot_dir, "/gg_corrplot.svg"), width=800, height=800)
    corrplot(cor_matrix, method="color", col=col(200),
         order="hclust", addrect=3, number.cex = 0.8, #type = "upper", 
         addCoef.col="black", # Add coefficient of correlation
         tl.col="black", tl.srt=30, cl.pos="b", # Text label, color, and rotation
         # Combine with significance
         p.mat = p_values$p, sig.level=0.05, insig="blank", 
         # hide correlation coefficient on the principal diagonal
         # diag = FALSE
         )
    dev.off()
  }
}
```

```{r Create regression data}
get_regression_dat = function(all_files) {
  
  all_files_regr = subset(all_files, select = c("sID", "TrialID", "block", "reward", "selected_box"))
  all_files_regr$selected = as.numeric(as.character(factor(all_files_regr$selected_box, levels = c(0, 1), labels = c(-1, 1))))  # 0 / -1: left; +1: right
  
  ## Choice regressors
  all_files_regr$right_rew = all_files_regr$selected_box
  all_files_regr$right_rew[all_files_regr$reward == 0] = -all_files_regr$right_rew[all_files_regr$reward == 0]
  all_files_regr$left_rew = 1 - all_files_regr$selected_box
  all_files_regr$left_rew[all_files_regr$reward == 0] = -all_files_regr$left_rew[all_files_regr$reward == 0]
  
  ## Reward regressors
  all_files_regr$reward = all_files_regr$reward
  all_files_regr$reward[all_files_regr$selected_box == 0] = -all_files_regr$reward[all_files_regr$selected_box == 0]
  all_files_regr$noReward = 1 - all_files_regr$reward
  all_files_regr$noReward[all_files_regr$selected_box == 0] = -all_files_regr$noReward[all_files_regr$selected_box == 0]
  all_files_regr$selected_box = factor(all_files_regr$selected_box)
  
  all_files_regr = subset(all_files_regr, !is.na(selected_box))
  
  return(all_files_regr)
}
```
```{r Run regression model}
run_regression = function(all_files_regr) {
    
  # Run regression models for each subject, for each n in n-back
  sel_rew_predictors = c("selected", "reward")
  choice_predictors = c("left_rew", "right_rew")
  reward_predictors = c("reward", "noReward")
  
  nback_regr_dat = data.frame()
  for (subj in unique(all_files_regr$sID)) {
    for (n in 1:12) {
      subj_dat = subset(all_files_regr, sID == subj & !is.na(selected_box))

      if (nrow(subj_dat) > 0) {

        ## Add nback columns
        for (cond in c(choice_predictors, reward_predictors, sel_rew_predictors)) {
          col_name = paste0("back", n, cond)
          subj_dat[,col_name] = c(rep(NA, n), subj_dat[1:(nrow(subj_dat)-n), cond])
        }

        ## Selected/rewarded model (predictors: selected [left: -1, right: +1], reward [left: -1, right: +1, none: 0])
        sel_rew_formula = paste("selected_box ~", paste(paste0("back", n, sel_rew_predictors), collapse = " + "), "+ (1 | block)")
        sel_rew_mod = glm(as.formula(sel_rew_formula),
                  family = "binomial",
                  data = subj_dat)
        sel_rew_coefs = as.data.frame(summary(sel_rew_mod)$coef)
        sel_rew_coefss = cbind(sID = subj, model = "selectedRewarded", predictor = rownames(sel_rew_coefs), back = n, data.frame(sel_rew_coefs, row.names = NULL))

        ## Choice model (predictors: left_rew [reward: +1, no reward: -1, none: 0], right_rew [reward: +1, no reward: -1, none: 0])
        choice_formula = paste("selected_box ~ ", paste(paste0("back", n, choice_predictors), collapse = " + "))
        choice_mod = glm(as.formula(choice_formula),
                  family = "binomial",
                  data = subj_dat)
        choice_coefs = as.data.frame(summary(choice_mod)$coef)
        choice_coefss = cbind(sID = subj, model = "leftRight", predictor = rownames(choice_coefs), back = n, data.frame(choice_coefs, row.names = NULL))

        ## Reward model (predictors: reward [left: -1, right: +1, none: 0], no reward [left: -1, right: +1, none: 0])
        reward_formula = paste("selected_box ~", paste(paste0("back", n, reward_predictors), collapse = " + "))
        reward_mod = glm(as.formula(reward_formula),
                  family = "binomial",
                  data = subj_dat)
        reward_coefs = as.data.frame(summary(reward_mod)$coef)
        reward_coefss = cbind(sID = subj, model = "rewardNoReward", predictor = rownames(reward_coefs), back = n, data.frame(reward_coefs, row.names = NULL))

        nback_regr_dat = rbind(nback_regr_dat, choice_coefss, reward_coefss, sel_rew_coefss)
      }
    }
  }
  # Beautify
  nback_regr_dat = merge(nback_regr_dat, ages, all.x = T)
  nback_regr_dat$predictor = gsub("back.", "", nback_regr_dat$predictor)
  nback_regr_dat$predictor = gsub("[0-99]", "", nback_regr_dat$predictor)
  nback_regr_dat$sig_Estimate = 1 / (1 + exp(-nback_regr_dat$Estimate / 2))  # transform so that I can see all
  
  # Summarize over versions (for simulated_humans)
  nback_regr_dat = ddply(nback_regr_dat,
                         colnames(nback_regr_dat)[colnames(nback_regr_dat) != "version"],
                         summarize,
                         X = sID[1])
  
  return(nback_regr_dat)
}
```
```{r Plot regression results}
plot_regression = function(nback_regr_dat, gg_save) {
  
  # Kraken plot: Changes with age
  gg_nback_regr_agecont =
    ggplot(subset(nback_regr_dat, predictor != "(Intercept)" & back %in% seq(1, 12, 2)),
           aes(PreciseYrs, Estimate, color = predictor, fill = predictor, alpha = factor(12 - back))) +
    geom_smooth() +
    geom_point() +
    labs(x = "Age (years)", y = "P(right) ~ choice_reward", color = "Choice", fill = "Choice", alpha = "# Trials back: 12-...") +
    facet_grid(~ model)
  gg_nback_regr_agecont_sig = gg_nback_regr_agecont + aes(y = sig_Estimate)
  
  # Same, but categorical
  gg_nback_regr_agecats =
    ggplot(subset(nback_regr_dat, predictor != "(Intercept)"), aes(back, Estimate, color = age_group, group = age_group)) +
    stat_summary(fun.data = mean_se, geom = "errorbar", width=0) +
    stat_summary(fun.data = mean_se, geom = "line") +
    scale_color_manual(values=colors_3and1) +
    labs(x = "# trials back", y = "beta weight", color = "Side") +
    facet_grid( ~ predictor)
  gg_nback_regr_agecats_sig = gg_nback_regr_agecats + aes(y = sig_Estimate)
  
  # Effect of reward and no reward on choice
  rewnorew_dat = subset(nback_regr_dat, model == "rewardNoReward" & predictor != "(Intercept)")
  rewnorew_dat$Columbia_cat = factor(rewnorew_dat$Columbia_cat)
  rewnorew_regr =
    ggplot(rewnorew_dat, aes(back, Estimate, color = age_group)) +
    stat_summary(fun.data = mean_se, geom = "errorbar", width=0) +
    stat_summary(fun.data = mean_se, geom = "line") +
    geom_hline(yintercept = 0, linetype = "dashed") +
    scale_color_manual(values=colors_3and1) +
    coord_cartesian(xlim = c(1, 9)) +
    scale_x_continuous(breaks = seq(1, 9, 2)) +
    labs(x = "Trials back", y = "Regression weight", color = "Age") +
    facet_grid(predictor ~ Gender, scales="free")
  rewnorew_regr_PDS = rewnorew_regr + aes(color=PDS_group) + labs(color="PDS")
  rewnorew_regr_T = rewnorew_regr + aes(color=T_group) + labs(color="Testost.")
  rewnorew_regr_T$data = subset(rewnorew_regr$data, !is.na(T_group))
  
  if (gg_save) {
    ggsave(file.path(plot_dir, "gg_nback_regr_agecats.png"), gg_nback_regr_agecats) #8, height=1 + 2 * length(unique(gg_ACC_blocks$data$model_name)))
    ggsave(file.path(plot_dir, "gg_nback_regr_agecats_sig.png"), gg_nback_regr_agecats_sig) #8, height=1 + 2 * length(unique(gg_ACC_blocks$data$model_name)))
    ggsave(file.path(plot_dir, "gg_nback_regr_agecont.png"), gg_nback_regr_agecont) #7, height=12)
    ggsave(file.path(plot_dir, "gg_nback_regr_agecont_sig.png"), gg_nback_regr_agecont_sig) #7, height=12)
    ggsave(file.path(plot_dir, "rewnorew_regr_age.png"), rewnorew_regr) #5, height=3 + length(unique(gg_ACC_blocks$data$model_name)))
    ggsave(file.path(plot_dir, "rewnorew_regr_PDS.png"), rewnorew_regr_PDS) #5, height=3 + length(unique(gg_ACC_blocks$data$model_name)))
    ggsave(file.path(plot_dir, "rewnorew_regr_T.png"), rewnorew_regr_T) #5, height=3 + length(unique(gg_ACC_blocks$data$model_name)))
  }
}
```

# Main script

```{r Load packages, set parameters}
library("ggplot2"); theme_set(theme_bw()); library("plyr"); library("reshape2"); library("R.matlab"); library("zoo"); library(lmerTest)#; library("corrplot")#; library("Hmisc")

gg_save = T
run_regression = F
data_name = "human"  # Can be "human", "fitted_human", or "simulated_human"
exclude_UCB = F
colors_3and1 = c("#00D000", "#00C055", "#00B0AA", "#00A0FF", "gray60", "grey50")
parameter_names = c('alpha', 'beta', 'nalpha', 'calpha', 'cnalpha', 'p_switch', 'p_reward', 'persev')
desired_columns = c("sID", "version", "selected_box", "p_right", "reward", "RT", "correct", "correct_box", "learning_style", "model_name", "NLL", parameter_names, paste0(parameter_names, "_rec"))

# Directories of all the stuff
ages_file_dir = "C:/Users/maria/MEGAsync/SLCNdata/SLCNinfo2.csv"
human_data_dir = "C:/Users/maria/MEGAsync/SLCNdata/ProbSwitch"
param_file_dir = "C:/Users/maria/MEGAsync/SLCN/PShumanData/fitting/map_indiv/new_mcmc_models_cluster"
dir_to_all_simulations = 'C:/Users/maria/MEGAsync/SLCN/PShumanData/fitting/map_indiv/new_ML_models/MCMC/clustermodels/simulate/simulations'

# Notes
# ggsave(..., useDingbats=FALSE) is supposed to help with illustrator problems
```

```{r Run everything}
if (data_name == "simulated_human") {
  
  data_dirs = list.dirs(dir_to_all_simulations, recursive=F)
  patt = ".*csv"
  
  for (data_dir in data_dirs) {
    # data_dir = 'C:/Users/maria/MEGAsync/SLCN/PShumanData/fitting/map_indiv/new_ML_models/MCMC/clustermodels/simulate/simulations/Bbpr_age_z_271'
    folder_name = strsplit(data_dir, "/")[[1]][length(strsplit(data_dir, "/")[[1]])]
    model_name = strsplit(folder_name, "_")[[1]][1]
    print(model_name)
    
    # Create plot_dir
    plot_dir = file.path(data_dir, "Plots")
    if (!dir.exists(plot_dir)) {
      dir.create(plot_dir)
    }
    
    # Get data
    ages = get_ages(ages_file_dir)
    all_files = get_data(data_dir, data_name, patt)
    all_files = finish_all_files(all_files, ages)
    
    # Exclude subjects
    excl_subj = plot_indivduals_for_exclusion(all_files, gg_save, exclude_UCB)
    all_files = subset(all_files, !sID %in% excl_subj)
    
    # Create summary data
    stuff = get_ACC_reward_subj(all_files)
    ACC_subj = stuff[[1]]
    reward_subj = stuff[[2]]
    ACCs = stuff[[3]]
    wsls = get_wsls(all_files)
    all_files_sum = get_all_files_sum(all_files)
    
    # Sample overview
    plot_sample_composition(all_files, gg_save, run_regression)
    plot_switch_age_T_PDS(ACC_subj, reward_subj, run_regression, gg_save)
      
    # Behavioral analyses
    plot_performance_over_age(ACCs, gg_save)
    plot_RTs_ACC_choice_rewards_stay(all_files, ACC_subj, reward_subj, all_files_sum, gg_save)
    plot_wsls(wsls, gg_save)
  
    # Regression plots
    all_files_regr = get_regression_dat(all_files)
    nback_regr_dat = run_regression(all_files_regr)
    plot_regression(nback_regr_dat, gg_save)
    
    # Parameter analyses
    correlate_params_behavior(all_files, human_data_dir, model_name, gg_save)
  }
  
} else if (data_name == "human") {
  
  patt = ".*mat"
  
  # Create plot_dir
  plot_dir = file.path(human_data_dir, "PlotsWithUCB")
  if (!dir.exists(plot_dir)) {
    dir.create(plot_dir)
  }
  
  # Get data
  ages = get_ages(ages_file_dir)
  all_files = get_data(human_data_dir, data_name, patt)
  all_files = finish_all_files(all_files, ages)
  
  # Exclude subjects
  excl_subj = plot_indivduals_for_exclusion(all_files, gg_save, exclude_UCB)
  all_files = subset(all_files, !sID %in% excl_subj)
  
  # Create summary data
  stuff = get_ACC_reward_subj(all_files)
  ACC_subj = stuff[[1]]
  reward_subj = stuff[[2]]
  ACCs = stuff[[3]]
  wsls = get_wsls(all_files)
  all_files_sum = get_all_files_sum(all_files)
  
  # Sample overview
  plot_sample_composition(all_files, gg_save, run_regression)
  plot_switch_age_T_PDS(ACC_subj, reward_subj, run_regression, gg_save)
    
  # Behavioral analyses
  plot_performance_over_age(ACCs, gg_save)
  plot_RTs_ACC_choice_rewards_stay(all_files, ACC_subj, reward_subj, all_files_sum, gg_save)
  plot_wsls(wsls, gg_save)
  
  # Regression plots
  all_files_regr = get_regression_dat(all_files)
  nback_regr_dat = run_regression(all_files_regr)
  plot_regression(nback_regr_dat, gg_save)
}
```

# Run regression models

```{r CCN paper}

# Add quadratic age columns and within-sex z-scored T columns
all_files$PreciseYrs2 = all_files$PreciseYrs ^ 2
all_files$PDS2 = all_files$PDS ^ 2
all_files$logTz = NA
all_files$logTz[all_files$Gender == "Female"] = (all_files$log_T[all_files$Gender == "Female"] - mean(all_files$log_T[all_files$Gender == "Female"], na.rm=T)) / sd(all_files$log_T[all_files$Gender == "Female"], na.rm=T)
all_files$logTz[all_files$Gender == "Male"] = (all_files$log_T[all_files$Gender == "Male"] - mean(all_files$log_T[all_files$Gender == "Male"], na.rm=T)) / sd(all_files$log_T[all_files$Gender == "Male"], na.rm=T)
all_files$logTz2 = all_files$logTz ^ 2

nback_regr_dat$PreciseYrs2 = nback_regr_dat$PreciseYrs ^ 2
nback_regr_dat$logTz = NA
nback_regr_dat$logTz[nback_regr_dat$Gender == "Female"] = (nback_regr_dat$log_T[nback_regr_dat$Gender == "Female"] - mean(nback_regr_dat$log_T[nback_regr_dat$Gender == "Female"], na.rm=T)) / sd(nback_regr_dat$log_T[nback_regr_dat$Gender == "Female"], na.rm=T)
nback_regr_dat$logTz[nback_regr_dat$Gender == "Male"] = (nback_regr_dat$log_T[nback_regr_dat$Gender == "Male"] - mean(nback_regr_dat$log_T[nback_regr_dat$Gender == "Male"], na.rm=T)) / sd(nback_regr_dat$log_T[nback_regr_dat$Gender == "Male"], na.rm=T)

# Effect of age on basic behavior (rewards, RTs)
summary(lmer(log(RT) ~ PreciseYrs + PreciseYrs2 + Gender + (1 | sID), subset(all_files, ACC==T)))
summary(glmer(reward ~ PreciseYrs + PreciseYrs2 + Gender + (1 | sID), all_files, binomial))
summary(glmer(same_choice_01_back ~ PreciseYrs + PreciseYrs2 + Gender + (1 | sID), all_files, binomial))

t.test(mean_reward ~ age_group, subset(ACCs, age_group %in% c("100%", "Adult")))
t.test(median_cor_RT ~ age_group, subset(ACCs, age_group %in% c("100%", "Adult")))
t.test(mean_stay ~ age_group, subset(ACCs, age_group %in% c("100%", "Adult")))

# Effect of age / PDS / T on switch speed
ddply(ddply(subset(all_files, trialsinceswitch==1), .(sID, age_group), summarize, ACC=mean(ACC)), .(age_group), summarize, ACC=mean(ACC))

summary(glmer(ACC ~ PreciseYrs + PreciseYrs2 + Gender + (1 | sID), subset(all_files, trialsinceswitch==1), binomial))
summary(glmer(ACC ~ PDS + Gender + (1 | sID), subset(all_files, trialsinceswitch==1 & PreciseYrs < 20), binomial))
summary(glmer(ACC ~ logTz + Gender + (1 | sID), subset(all_files, trialsinceswitch==1 & PreciseYrs < 20), binomial))

# Younger participants switched faster than older participants, as revealed by the effect of age on staying in the 'reward, no reward' condition in a mixed-effects regression model in non-adult participants (females: $\beta=3.79\%$, $p<0.001$, males: $\beta=3.61\%$, $p<0.001$
summary(lmer(same_choice_01_back ~ PreciseYrs + PreciseYrs2 + Gender + (1 | sID), subset(all_files, outcome_21_back=='reward, no reward')))
summary(lmer(same_choice_01_back ~ PDS + Gender + (1 | sID), subset(all_files, outcome_21_back=='reward, no reward' & PreciseYrs < 20)))
summary(lmer(same_choice_01_back ~ logTz + Gender + (1 | sID), subset(all_files, outcome_21_back=='reward, no reward' & PreciseYrs < 20)))

# At the same time, younger participants reached lower long-term performance, as revealed in the significant effect of age on accuracy in a logistic regression in trials 3-7 post-switch (females: all $\beta's > 0.088$, all $p's < 0.43$, males: all $\beta's > 0.099$, all $p's< 0.032$; Fig. \ref{figure:BehaviorHuman}A)
for (since in c(-3:-2, 3:7)) {
  print(paste("trials since switch:", since))
  # print(summary(glmer(ACC ~ PreciseYrs + PreciseYrs2 + Gender + (1 | sID), subset(all_files, trialsinceswitch == since), binomial)))
  # print(summary(glmer(ACC ~ PDS + Gender + (1 | sID), subset(all_files, trialsinceswitch == since & PreciseYrs < 20), binomial)))
  print(summary(glmer(ACC ~ logTz + Gender + (1 | sID), subset(all_files, trialsinceswitch == since & PreciseYrs < 20), binomial)))
}

# Indeed, younger children showed greater sensitivity to negative reward in a logistic regression predicting actions on trial $t+i$ from actions and outcomes on trial $t$, as revealed by significant effect of age on the regression coefficients (females: $\beta=0.54$, $p=0.0026$, males: $\beta=0.33$, $p=0.019$, Fig. \ref{figure:BehaviorHuman}).
print(summary(lm(Estimate ~ PreciseYrs + PreciseYrs2 + Gender + back, subset(nback_regr_dat, model == "rewardNoReward" & predictor == "reward" & back %in% 1:5))))
print(summary(lm(Estimate ~ PreciseYrs + PreciseYrs2 + Gender + back, subset(nback_regr_dat, model == "rewardNoReward" & predictor == "noReward" & back %in% 1:5))))

print(summary(lm(Estimate ~ PDS + Gender + back, subset(nback_regr_dat, model == "rewardNoReward" & predictor == "reward" & back %in% 1:5 & PreciseYrs < 20))))
print(summary(lm(Estimate ~ PDS + Gender + back, subset(nback_regr_dat, model == "rewardNoReward" & predictor == "noReward" & back %in% 1:5 & PreciseYrs < 20))))
print(summary(lm(Estimate ~ logTz + Gender + back, subset(nback_regr_dat, model == "rewardNoReward" & predictor == "reward" & back %in% 1:5 & PreciseYrs < 20))))
print(summary(lm(Estimate ~ logTz + Gender + back, subset(nback_regr_dat, model == "rewardNoReward" & predictor == "noReward" & back %in% 1:5 & PreciseYrs < 20))))
  
for (backi in 1:5) {
  print(paste("Back:", backi))
  # print(summary(lm(Estimate ~ PreciseYrs + PreciseYrs2 + Gender, subset(nback_regr_dat, model == "rewardNoReward" & predictor == "noReward" & back == backi))))
  print(summary(lm(Estimate ~ PreciseYrs + PreciseYrs2 + Gender, subset(nback_regr_dat, model == "rewardNoReward" & predictor == "reward" & back == backi))))
}
```
```{r}
# infos = strsplit(colnames(fitted_slopes)[2:length(colnames(fitted_slopes))], "_")
# 
# parameter_names = vector()
# variable_names = vector()
# for (info in infos) {
#   # Add parameter name
#   parameter_names = c(parameter_names, info[1])
#   
#   # Add lin, qua, int
#   if (info[2] == 2) {
#     variable_names = c(variable_names, "slope2")
#   } else {
#     variable_names = c(variable_names, info[2])
#   }
# }
# 
# slopes = data.frame(parameter=parameter_names, effect=variable_names, value=as.numeric(subset(fitted_slopes, X=="mean")[2:ncol(fitted_slopes)]))
```

```{r Analyze and plot fitted parameters}
plot_parameters = function(fitted_param_dir, model, plot_appx) {
  
  # Read in and clean fitted parameter data
  fitted_params = read.csv(fitted_param_dir)
  
  if (model == "RL") {
    fitted_params$alpha_minus_calpha = with(fitted_params, alpha - calpha)
    fitted_params$alpha_minus_nalpha = with(fitted_params, alpha - nalpha)
    fitted_params$nalpha_minus_cnalpha = with(fitted_params, nalpha - cnalpha)
    
    param_cols = c("sID", "beta", "persev", "alpha", "nalpha", "calpha", "cnalpha", "alpha_minus_calpha", "alpha_minus_nalpha", "nalpha_minus_cnalpha")
  } else {
    param_cols = c("sID", "beta", "persev", "p_switch", "p_reward")
  }
  
  fitted_params = merge(subset(fitted_params, select=param_cols), ages, by='sID', all.x=T)
  fp_long = melt(fitted_params, id.vars=c("sID", "Gender", "age_group", "PDS_group", "T_group", "PreciseYrs"), measure.vars=param_cols[2:length(param_cols)], variable.name="parameter")
  fp_llong = melt(fp_long, measure.vars=c("age_group", "PDS_group", "T_group"), variable.name="group", value.name="percent")
  fp_llong$percent = factor(fp_llong$percent, levels=c("25%", "50%", "75%", "100%", "Adult", NA))
    
  # Plot parameters over age groups
  gg_params_ages_free =
    ggplot(subset(fp_llong, !is.na(percent) & parameter %in% c("alpha_minus_calpha", "alpha_minus_nalpha", "nalpha_minus_cnalpha", "beta")), aes(percent, value, color=Gender, group=Gender)) +
    stat_summary(fun.data=mean_se, geom="pointrange") +
    stat_summary(fun.data=mean_se, geom="line") +
    facet_grid(parameter ~ group, scales="free")
  
  gg_params_ages_01 = gg_params_ages_free + coord_cartesian(ylim=c(0, 1))
  gg_params_ages_01$data = subset(fp_llong, !is.na(percent) & parameter %in% c("alpha", "nalpha", "calpha", "cnalpha", "p_switch", "p_reward"))
  
  gg_params_ages_beta = gg_params_ages_free + coord_cartesian(ylim=c(1, 11))
  gg_params_ages_beta$data = subset(fp_llong, !is.na(percent) & parameter %in% c("beta"))
  
  gg_params_ages_p = gg_params_ages_free + coord_cartesian(ylim=c(-0.25, 0.75))
  gg_params_ages_p$data = subset(fp_llong, !is.na(percent) & parameter %in% c("persev"))
  
  # Calculate ANOVAs and t-tests to see age group differences
  for (predictor in c("age_group", "PDS_group", "T_group")) {#
    for (param in param_cols[2:length(param_cols)]) {
      print(paste(predictor, param))
      
      formula = as.formula(paste(param, "~", predictor, " + Gender"))
      # print(summary(aov(formula, subset(fitted_params, !age_group %in% c("UCB")))))#
      
      # print(pairwise.t.test(fitted_params[,param], fitted_params[,predictor], p.adjust.method="none"))
    }
  }
  
  if (gg_save) {
    ggsave(file.path(plot_dir, paste0("gg_params_ages_free_", model, plot_appx, ".png")), gg_params_ages_free, width=8, height=8)
    ggsave(file.path(plot_dir, paste0("gg_params_ages_01_", model, plot_appx, ".png")), gg_params_ages_01, width=8, height=4.5)
    ggsave(file.path(plot_dir, paste0("gg_params_ages_beta_", model, plot_appx, ".png")), gg_params_ages_beta, width=8, height=2.5)
    ggsave(file.path(plot_dir, paste0("gg_params_ages_p_", model, plot_appx, ".png")), gg_params_ages_p, width=8, height=2.5)
  }
}

plot_parameters(fitted_param_dir="C:/Users/maria/MEGAsync/SLCN/PShumanData/fitting/map_indiv/new_ML_models/params_RLabcnpx_age_z_271_pymc3.csv", model="RL", plot_appx="_ML")
# plot_parameters(fitted_param_dir="C:/Users/maria/MEGAsync/SLCN/PShumanData/fitting/map_indiv/new_ML_models/MCMC/clustermodels/params_RLabcxnplyoqtu_age_z_271_pymc3.csv", model="RL", "_MCMC")
# plot_parameters(fitted_param_dir="C:/Users/maria/MEGAsync/SLCN/PShumanData/fitting/map_indiv/new_ML_models/MCMC/clustermodels/params_RLabcnpx_age_z_271_pymc3.csv", model="RL", "_MCMC_sep")

plot_parameters(fitted_param_dir="C:/Users/maria/MEGAsync/SLCN/PShumanData/fitting/map_indiv/new_ML_models/params_Bbpr_age_z_271_pymc3.csv", model="BF", plot_appx="_ML")
plot_parameters(fitted_param_dir="C:/Users/maria/MEGAsync/SLCN/PShumanData/fitting/map_indiv/new_ML_models/MCMC/clustermodels/params_Bbprytv_age_z_271_pymc3.csv", "BF", "_MCMC")
plot_parameters(fitted_param_dir="C:/Users/maria/MEGAsync/SLCN/PShumanData/fitting/map_indiv/new_ML_models/MCMC/clustermodels/params_Bbpr_age_z_271_pymc3.csv", "BF", "_MCMC_sep")
```
```{r Compare RL and BF parameters}
# ML fitting
RL_ML_dir = "C:/Users/maria/MEGAsync/SLCN/PShumanData/fitting/map_indiv/new_ML_models/params_RLabcnpx_age_z_271_pymc3.csv"
BF_ML_dir = "C:/Users/maria/MEGAsync/SLCN/PShumanData/fitting/map_indiv/new_ML_models/params_Bbpr_age_z_271_pymc3.csv"

# Bayesian fitting
RL_ML_dir = "C:/Users/maria/MEGAsync/SLCN/PShumanData/fitting/map_indiv/new_ML_models/MCMC/clustermodels/params_RLabcnpx_age_z_271_pymc3.csv"
BF_ML_dir = "C:/Users/maria/MEGAsync/SLCN/PShumanData/fitting/map_indiv/new_ML_models/MCMC/clustermodels/params_Bbpr_age_z_271_pymc3.csv"

params_RL = subset(read.csv(RL_ML_dir), select=c("beta", "persev", "alpha", "nalpha", "calpha", "cnalpha", "sID"))
params_BF = subset(read.csv(BF_ML_dir), select=c("beta", "persev", "p_switch", "p_reward", "sID"))

params = merge(params_RL, params_BF, by="sID", suffixes=c("_RL", "_BF"))

ggplot(params, aes(beta_RL, beta_BF)) +
  geom_point()
ggplot(params, aes(persev_RL, persev_BF)) +
  geom_point()

cor.test(params$beta_BF, params$beta_RL, method="pearson")
cor.test(params$persev_BF, params$persev_RL, method="pearson")
cor.test(params$cnalpha, params$p_reward, method="pearson")

library("corrplot")
cor_matrix = cor(params, use="complete.obs")
p_values = cor.mtest(params, conf.level = .95)

png(file.path(plot_dir, "/gg_RL_BF_params.png"), pointsize=15, width=600, height=600)
corrplot(cor_matrix)
corrplot(cor_matrix, method="color", #col=col(200),
     number.cex = 0.8, #type = "upper", 
     addCoef.col="black", # Add coefficient of correlation
     tl.col="black", tl.srt=30, cl.pos="b", # Text label, color, and rotation
     # Combine with significance
     p.mat = p_values$p, sig.level=0.05, insig="blank",
     # hide correlation coefficient on the principal diagonal
     # diag = FALSE
     )
# corrplot(cor_matrix, p.mat=p_values$p, method="color", order="hclust", insig="label_sig", pch="p" addrect=4)
# corrplot(cor_matrix, type="upper", tl.col="black", tl.srt=45)
dev.off()
```
```{r GenRec}
# ML fitting
simBF_params = read.csv("C:/Users/maria/MEGAsync/SLCN/PShumanData/fitting/map_indiv/new_ML_models/simulate/params_Bbpr_age_z_271_pymc3.csv")
recBF_params = read.csv("C:/Users/maria/MEGAsync/SLCN/PShumanData/fitting/map_indiv/new_ML_models/gen_rec/params_simBbprrecBbpr_age_z_271_pymc3.csv")
simRL_params = read.csv("C:/Users/maria/MEGAsync/SLCN/PShumanData/fitting/map_indiv/new_ML_models/simulate/params_RLabcnpx_age_z_271_pymc3.csv")
recRL_params = read.csv("C:/Users/maria/MEGAsync/SLCN/PShumanData/fitting/map_indiv/new_ML_models/gen_rec/params_simRLabcnpxrecRLabcnpx_age_z_271_pymc3.csv")

# Bayesian fitting
simBF_params = read.csv("C:/Users/maria/MEGAsync/SLCN/PShumanData/fitting/map_indiv/new_ML_models/MCMC/clustermodels/params_Bbpr_age_z_271_pymc3.csv")
recBF_params = read.csv("C:/Users/maria/MEGAsync/SLCN/PShumanData/fitting/map_indiv/new_ML_models/MCMC/clustermodels/genrec/simBbpr/params_Bbpr_age_z_271_pymc3.csv")
simRL_params = read.csv("C:/Users/maria/MEGAsync/SLCN/PShumanData/fitting/map_indiv/new_ML_models/MCMC/clustermodels/params_RLabcnpx_age_z_271_pymc3.csv")
recRL_params = read.csv("C:/Users/maria/MEGAsync/SLCN/PShumanData/fitting/map_indiv/new_ML_models/MCMC/clustermodels/genrec/simRLabcnpx/params_RLabcnpx_age_z_271_pymc3.csv")

# Plots
BF_params =
  merge(melt(subset(simBF_params, select=c("beta", "persev", "p_switch", "p_reward", "sID")), id.var="sID", variable.name="param"),
        melt(subset(recBF_params, select=c("beta", "persev", "p_switch", "p_reward", "sID")), id.var="sID", variable.name="param"),
        by=c("sID", "param"), suffixes=c("_sim", "_rec"))
gg_genrec_BF =
  ggplot(BF_params, aes(value_sim, value_rec)) +
    geom_point() +
    facet_wrap(~ param, scales="free")

RL_params =
  merge(melt(subset(simRL_params, select=c("beta", "persev", "alpha", "nalpha", "calpha", "cnalpha", "sID")), id.var="sID", variable.name="param"),
        melt(subset(recRL_params, select=c("beta", "persev", "alpha", "nalpha", "calpha", "cnalpha", "sID")), id.var="sID", variable.name="param"),
        by=c("sID", "param"), suffixes=c("_sim", "_rec"))
gg_genrec_RL =
  ggplot(RL_params, aes(value_sim, value_rec)) +
    geom_point() +
    facet_wrap(~ param, scales="free")

if (gg_save) {
  ggsave(file.path(plot_dir, "gg_genrec_BF.png"), gg_genrec_BF, width=8, height=8)
  ggsave(file.path(plot_dir, "gg_genrec_RL.png"), gg_genrec_RL, width=12, height=8)
}
```

```{r regression ACC / RT ~ age * testosterone}

# Vizualize effects of age and testosterone on ACC & RT
median_RT = ddply(subset(all_files, ACC=T), .(sID, Gender, PreciseYrs, log_T), RT=median(RT), log_T=median(log_T), z=NA, summarize)
# gg_age_testosterone =
  ggplot(median_RT, aes(PreciseYrs, log_T, color=Gender)) + geom_point()

# gg_age_RT =
  ggplot(subset(median_RT, PreciseYrs<24), aes(PreciseYrs, RT, color=log_T)) + geom_point() + geom_smooth()
# gg_T_RT =
  ggplot(subset(median_RT, PreciseYrs<24), aes(log_T, RT, color=Gender)) + geom_point() + geom_smooth()

# gg_age_RT =
  ggplot(subset(median_RT, PreciseYrs>=11 & PreciseYrs<=14), aes(PreciseYrs, RT, color=log_T)) + geom_point() + geom_smooth()
# gg_T_RT =
  ggplot(subset(median_RT, PreciseYrs>=11 & PreciseYrs<=14), aes(log_T, RT, color=Gender)) + geom_point() + geom_smooth()

mean_ACC = ddply(all_files, .(sID, Gender, PreciseYrs, log_T), ACC=mean(ACC), log_T=median(log_T), summarize)
# gg_age_ACC =
  ggplot(subset(mean_ACC, PreciseYrs<24), aes(PreciseYrs, ACC, color=log_T)) + geom_point() + geom_smooth()
# gg_T_ACC =
  ggplot(subset(mean_ACC, PreciseYrs<24), aes(log_T, ACC, color=Gender)) + geom_point() + geom_smooth()
  
# gg_T_PDS =
  ggplot(subset(all_files, PreciseYrs<20), aes(PDS, log_T, color=PreciseYrs, shape=factor(Gender))) + geom_point()

# z-score predictors
# Calculate regression models
reg_dat = subset(all_files, age_group!="25-30")
# reg_dat = subset(all_files, PreciseYrs>=11 & PreciseYrs<=14)
# reg_dat = subset(all_files, PreciseYrs<20)
reg_dat$PreciseYrs_z = (reg_dat$PreciseYrs - mean(reg_dat$PreciseYrs, na.rm=T)) / sd(reg_dat$PreciseYrs, na.rm=T)
reg_dat$T1_log = log(reg_dat$T1)
reg_dat$T1_z = (reg_dat$T1_log - mean(reg_dat$T1_log, na.rm=T)) / sd(reg_dat$T1_log, na.rm=T)
reg_dat$Gender = factor(reg_dat$Gender)
reg_dat$log_RT = log(reg_dat$RT)
# reg_dat$pub = (log(reg_dat$T1) - mean(log(reg_dat$T1), na.rm=T)) / sd(log(reg_dat$T1), na.rm=T) + (reg_dat$PDS - mean(reg_dat$PDS, na.rm=T)) / ggplot(reg_dat, aes(PreciseYrs, pub)) + geom_point()
hist(reg_dat$RT)
hist(reg_dat$log_RT)
summary(lmer(log_RT ~ PreciseYrs_z * T1_z + (1 | sID) + (1 | Gender), subset(reg_dat, ACC==T), na.action=na.omit, REML=F, verbose=T))
summary(glmer(ACC ~ PreciseYrs_z * T1_z + (1 | sID) + (1 | Gender), reg_dat, binomial))

summary(lmer(log_RT ~ PreciseYrs_z + (1 | sID) + (1 | Gender), subset(reg_dat, ACC==T), na.action=na.omit, REML=F, verbose=T))
summary(glmer(ACC ~ PreciseYrs_z + (1 | sID) + (1 | Gender), reg_dat, binomial))

summary(lmer(log_RT ~ PreciseYrs_z * T1_z + (1 | sID), subset(reg_dat, ACC==T & Gender=="Female"), na.action=na.omit, REML=F, verbose=T))
summary(lmer(log_RT ~ PreciseYrs_z * T1_z + (1 | sID), subset(reg_dat, ACC==T & Gender=="Male"), na.action=na.omit, REML=F, verbose=T))
summary(glmer(ACC ~ PreciseYrs_z * T1_z + (1 | sID), subset(reg_dat, Gender=="Female"), binomial))
summary(glmer(ACC ~ PreciseYrs_z * T1_z + (1 | sID), subset(reg_dat, Gender=="Male"), binomial))

# summary(subset(reg_dat, is.na(T1), select=c("RT", "log_RT", "T1", "T1_z", "PreciseYrs", "PreciseYrs_z"))$T1_z)
# summary(reg_dat)
```

```{r Fit exponential model to regression weights}
# Visualize one example
dat = subset(nback_regr_dat, sID == unique(nback_regr_dat$sID)[1] & predictor == "reward")
# exp_mod = nls(Estimate ~ k * exp(-lambda * back), data = dat, start = list(k = .1, lambda = .1))
exp_mod = nls(Estimate ~ k * exp(-back), data = dat, start = list(k = .1))
plot(dat$back, dat$Estimate)
lines(dat$back, predict(exp_mod, list(x = dat$back)))

# Run on all participants
exp_coefs = data.frame()
for (subj in unique(nback_regr_dat$sID)) {
  for (pred in unique(nback_regr_dat$predictor[nback_regr_dat$predictor != "(Intercept)"])) {
    subj_dat = subset(nback_regr_dat, sID == subj & predictor == pred)
    exp_mod =
      try(nls(Estimate ~ k * exp(-back), data = subj_dat, start = list(k = .1)), silent = T)
    if (class(exp_mod) != "try-error") {
      subj_coefs = summary(exp_mod)$coef
      # subj_coefs = cbind(sID = subj, regr_predictor = pred, exp_predictor = rownames(subj_coefs), as.data.frame(subj_coefs, row.names = F))
      subj_coefs = cbind(sID = subj, regr_predictor = pred, exp_predictor = rownames(subj_coefs), as.data.frame(subj_coefs, row.names = '1'))
      exp_coefs = rbind(exp_coefs, subj_coefs)
    }
  }
}
exp_coefs = merge(exp_coefs, ages, all.x = T)
exp_coefs$sig_Estimate = NA
exp_coefs$sig_Estimate[exp_coefs$exp_predictor == "k"] = 1 / (1 + exp(-exp_coefs$Estimate[exp_coefs$exp_predictor == "k"] / 5))
exp_coefs$sig_Estimate[exp_coefs$exp_predictor == "lambda"] = 1 / (1 + exp(-exp_coefs$Estimate[exp_coefs$exp_predictor == "lambda"] / .5))
```
```{r Plot parameters of the exponential model}
gg_exp_coefs_age = ggplot(exp_coefs, aes(PreciseYrs, Estimate, color = regr_predictor)) +
  geom_point() +
  geom_smooth() +
  labs(y = "Regr beta ~ k * exp(-lambda * back)") +
  facet_wrap(~ exp_predictor, scale = "free")
gg_exp_coefs_age_sig = gg_exp_coefs_age + aes(y = sig_Estimate)

gg_exp_coefs_agecat =
  ggplot(subset(exp_coefs), aes(age_group, Estimate, color = regr_predictor, group = regr_predictor)) +
  geom_point(position = "jitter", alpha = 0.2) +
  stat_summary(fun.data = mean_se) +
  labs(y = "Regr beta ~ k * exp(-lambda * back)") +
  stat_summary(fun.data = mean_se, geom = "line") +
  facet_wrap(~ exp_predictor, scale = "free")
gg_exp_coefs_agecat_sig = gg_exp_coefs_agecat + aes(y = sig_Estimate)

ggsave(file.path(plot_dir, "gg_exp_coefs_age_sig.png"), gg_exp_coefs_age_sig)
ggsave(file.path(plot_dir, "gg_exp_coefs_agecat_sig.png"), gg_exp_coefs_agecat_sig)
ggsave(file.path(plot_dir, "gg_exp_coefs_age.png"), gg_exp_coefs_age)
ggsave(file.path(plot_dir, "gg_exp_coefs_agecat.png"), gg_exp_coefs_agecat)
```
```{r Relationship with age and puberty: Other measures}
# Overall ACC
sum_dat_pre = ddply(all_files, .(sID, block, version, PreciseYrs, Gender, Category, PDS), summarize,
                ACC = mean(ACC, na.rm = T),
                RT = median(RT, na.rm = T),
                stay = mean(stay, na.rm = T))
sum_dat = ddply(sum_dat_pre, .(sID, PreciseYrs, Gender, Category, PDS), summarize,
                mean_ACC = mean(ACC, na.rm = T),
                median_RT = median(RT, na.rm = T),
                n_blocks = max(block, na.rm = T),
                stay = mean(stay, na.rm = T))

gg_age_ACC =
  ggplot(sum_dat, aes(PreciseYrs, mean_ACC)) +
  geom_point() +
  geom_smooth()
gg_age_RT = gg_age_ACC + aes(y = median_RT)
gg_PDS_ACC = gg_age_ACC + aes(x = PDS)
gg_PDS_RT = gg_PDS_ACC + aes(y = median_RT)
gg_age_n_blocks = gg_age_ACC + aes(y = n_blocks)
gg_PDS_n_blocks = gg_age_n_blocks + aes(x = PDS)
gg_age_overall_stay = gg_age_ACC + aes(y = stay)
gg_PDS_overall_stay = gg_age_overall_stay + aes(x = PDS)

# Trials to reach criterion
all_files$roll_ACC = rollmean(all_files$ACC, 3, fill = NA, align = "right")
all_files$roll_ACC[all_files$trialsinceswitch >= 0 & all_files$trialsinceswitch < 2] = NA
all_files$criterion_2of3 = all_files$roll_ACC >= 0.6
criterion_dat = ddply(subset(all_files, criterion_2of3 == T & trialsinceswitch > 0), .(sID, PreciseYrs, Gender, Category, PDS, block), summarize,
      trials_to_criterion = min(trialsinceswitch))

gg_age_criterion = ggplot(criterion_dat, aes(PreciseYrs, trials_to_criterion)) +
  geom_point() +
  geom_smooth()
gg_PDS_criterion = gg_age_criterion + aes(x = PDS)

# Prominence of WSLS
wsls_wide = reshape(subset(wsls, select = -age_group), direction = "wide", timevar = "reward", idvar = "sID")
wsls_wide$wsls = with(wsls_wide, stay.1 + (1 - stay.0))
wsls_wide = merge(wsls_wide, ages, all.x = T)
wsls = merge(wsls, ages, all.x = T)

gg_age_wsls = ggplot(wsls, aes(PreciseYrs, stay, color = reward)) +
  geom_point() +
  geom_smooth()
gg_PDS_wsls = gg_age_wsls + aes(x = PDS)
```
```{r}
# Effect of reward history
rewhist_dat_pre = ddply(all_files, .(sID, version, outcome_21_back), summarize,
                    stay = mean(same_choice_01_back, na.rm = T))
rewhist_dat = ddply(rewhist_dat_pre, .(sID, outcome_21_back), summarize,
                    stay = mean(stay))
rewhist_dat = merge(rewhist_dat, ages, all.x = T)
gg_age_rewhist =
  ggplot(subset(rewhist_dat, !is.na(outcome_21_back)), aes(PreciseYrs, stay, color = outcome_21_back)) +
  geom_point() +
    geom_smooth()
gg_PDS_rewhist = gg_age_rewhist + aes(x = PDS)

# RT variability || age
RT_sd_dat = ddply(all_files, .(sID, PreciseYrs, PDS), summarize,
      RT_sd = sd(RT, na.rm = T))
gg_age_RT_sd = ggplot(RT_sd_dat, aes(PreciseYrs, RT_sd)) +
  geom_point() +
  geom_smooth()
gg_PDS_RT_sd = gg_age_RT_sd + aes(x = PDS)

# Save plots
if (gg_save) {
  ggsave(file.path(plot_dir, "gg_age_criterion.png"), gg_age_criterion)
  ggsave(file.path(plot_dir, "gg_PDS_criterion.png"), gg_PDS_criterion)
  ggsave(file.path(plot_dir, "gg_PDS_ACC.png"), gg_PDS_ACC)
  ggsave(file.path(plot_dir, "gg_age_ACC.png"), gg_age_ACC)
  ggsave(file.path(plot_dir, "gg_age_wsls.png"), gg_age_wsls)
  ggsave(file.path(plot_dir, "gg_PDS_wsls.png"), gg_PDS_wsls)
  ggsave(file.path(plot_dir, "gg_age_rewhist.png"), gg_age_rewhist)
  ggsave(file.path(plot_dir, "gg_PDS_rewhist.png"), gg_PDS_rewhist)
  ggsave(file.path(plot_dir, "gg_age_n_blocks.png"), gg_age_n_blocks)
  ggsave(file.path(plot_dir, "gg_PDS_n_blocks.png"), gg_PDS_n_blocks)
  ggsave(file.path(plot_dir, "gg_age_overall_stay.png"), gg_age_overall_stay)
  ggsave(file.path(plot_dir, "gg_PDS_overall_stay.png"), gg_PDS_overall_stay)
}

if (data_name != "simulated_human") {
  # RT ~ trialID || age
  RT_slope_dat = data.frame()
  for (subj in unique(all_files$sID)) {
    subj_dat = subset(all_files, sID == subj)
    RT_mod = lm(RT ~ TrialID, data = subj_dat)
    coefs = as.data.frame(summary(RT_mod)$coefficients)
    coefss = cbind(sID = subj, predictor = rownames(coefs), data.frame(coefs, row.names = NULL))
    RT_slope_dat = rbind(RT_slope_dat, rbind(coefss))
  }
  RT_slope_dat = merge(RT_slope_dat, ages, all.x = T)
  
  gg_age_RT_slope = ggplot(subset(RT_slope_dat, predictor == "TrialID"), aes(PreciseYrs, Estimate)) +# & `Pr...t..` < 0.05
    geom_point() +
    geom_smooth()
  gg_PDS_RT_slope = gg_age_RT_slope + aes(x = PDS)

  # Save plots
  if (gg_save) {
    ggsave(file.path(plot_dir, "gg_age_RT.png"), gg_age_RT)
    ggsave(file.path(plot_dir, "gg_PDS_RT.png"), gg_PDS_RT)
    ggsave(file.path(plot_dir, "gg_age_RT_sd.png"), gg_age_RT_sd)
    ggsave(file.path(plot_dir, "gg_PDS_RT_sd.png"), gg_PDS_RT_sd)
    ggsave(file.path(plot_dir, "gg_age_RT_slope.png"), gg_age_RT_slope)
  }
}
```
```{r}
mean(all_files$switch_trial)
```
```{r Start button}
```
